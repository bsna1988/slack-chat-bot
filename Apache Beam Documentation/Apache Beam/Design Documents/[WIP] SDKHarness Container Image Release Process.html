<p><span style="color: rgb(153,51,0);"><em><strong>Please visit </strong></em></span><u><span style="color: rgb(51,102,255);"><a class="external-link" href="https://docs.google.com/document/d/1IKE_aEkrAzkzUE4pD_r_zVuL5amHGetJ1efnbTfmunM/edit" rel="nofollow" style="color: rgb(51,102,255);"><em><strong>Google Doc</strong></em></a></span></u><span style="color: rgb(153,51,0);"><em><strong> for review, wiki page will be updated after release plan is finalized.</strong></em></span></p><p><div class="toc-macro client-side-toc-macro  conf-macro output-block" data-hasbody="false" data-headerelements="H1,H2,H3,H4,H5,H6,H7" data-macro-name="toc"> </div></p><p>This page describes the release, validation, and other aspects related to SDKHarness images.</p><h1 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-Overview">Overview</h1><p>The idea is to build a set of public SDKHarness pre-built images, that users can utilize to run their portable pipelines without having to manually build them, or use these images as base images for customization.</p><h3 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-Backgroundinformation">Background information</h3><ul><li>SDKHarness architecture / design docs ?</li><li>Image structure ?</li><li>Source ? </li></ul><h1 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-Location/Naming">Location/Naming</h1><p>This section describes the naming scheme and location for publication of the images.</p><h3 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-Proposedrepository">Proposed repository</h3><p>We propose to use <strong>gcr.io/beam</strong>, created under <strong>apache-beam-testing</strong> project, artifacts accessible publicly. SDK Harness containers go to sdk folder.</p><p>Things to know about <a class="external-link" href="http://gcr.io" rel="nofollow">gcr.io</a>:</p><ul><li><strong>Quotas:</strong><ul><li>It seems like gcr only has hit limit from each IP, I didn't find any documentation about image limit. But it would have size limit.</li></ul></li><li><strong>Permissions:</strong><ul><li>download access - public</li><li>publish - limited to authorized accounts that have correct permissions under apache-beam-testing:<ul><li>publishing the snapshots nightly might be feasible similar to how we currently publish nightly maven snapshots, by creating a Jenkins job;</li><li>publishing at release time can be another job triggered manually by the release owner;<ul><li>Depends on how many tests we want to run. If need to run many tests, it should be a Jenkins job, otherwise, we can write a shell script to automate the process.</li></ul></li></ul></li></ul></li><li><strong>GCP Project:</strong><ul><li>apache-beam-testing</li></ul></li></ul><h3 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-Proposednamingandtaggingscheme">Proposed naming and tagging scheme</h3><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/><col/><col/></colgroup><tbody><tr><th class="confluenceTh"><br/></th><th style="text-align: center;" class="confluenceTh">Naming</th><th style="text-align: center;" class="confluenceTh">Tagging</th><th style="text-align: center;" class="confluenceTh">Example</th></tr><tr><td class="confluenceTd"><strong>Snapshot images</strong></td><td class="confluenceTd">language + language_version</td><td class="confluenceTd">yyyymmdd_{status} in UTC</td><td class="confluenceTd">gcr.io/apache-beam-testing/beam/sdk/snapshot/2019/08/20/java:20190820_verified</td></tr><tr><td class="confluenceTd"><strong>Release images</strong></td><td class="confluenceTd"><p>language + language_version</p><p><br/></p></td><td class="confluenceTd">Beam release version</td><td class="confluenceTd"><p>gcr.io/apache-beam-testing/beam/sdk/release/python2.7:2.10.1</p><p>gcr.io/apache-beam-testing/beam/sdk/release/java:2.10.1</p></td></tr></tbody></table></div><p><em>*Java and Go will not have language version until we support multi versions.</em></p><h1 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-PublicationSchedule">Publication Schedule</h1><h3 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-Snapshotimages">Snapshot images</h3><ul style="list-style-type: square;"><li><strong>how do we publish the snapshots, what's the frequency?</strong><ul style="list-style-type: square;"><li>automatic, when HEAD is built, nightly similar to maven snapshots.</li></ul></li><li><strong>when and how do we cleanup the snapshot images:</strong><ul style="list-style-type: square;"><li>when you publish an image you have a new version/hash and still can use any previous versions. They take space and will count towards a quota. We need to clean them up periodically:<ul style="list-style-type: square;"><li>make it part of the publish job to look and delete the versions that are more than X days (or versions) old?</li></ul></li></ul></li></ul><h3 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-ReleaseImages">Release Images</h3><ul><li><strong>How should we build and publish the images for release versions of Beam?</strong><ul><li>Start with manually, as part of Beam release and automate it later.</li></ul></li><li><strong>Should it be a blocker for the release?</strong><ul><li>Should we make it part of the release and not mark release as complete until the images are published?<ul><li>For first three release(v2.16 ~ v2.18), we can make it optional, and if all these release go well, we can make it mandatory part of the release(from v2.19).</li></ul></li><li>Should it be done by the same release owner?<ul><li>Yes, this document provides step by step guide about building, testing and pushing. In future, we can automate this process.</li></ul></li><li>Should the validation be part of the release validation?<ul><li>Yes, when we validate code base.</li></ul></li></ul></li></ul><h1 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-Dockerimages">Docker images</h1><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/><col/></colgroup><tbody><tr><th class="confluenceTh">Language</th><th class="confluenceTh">Supported versions</th><th class="confluenceTh">Docker image name</th></tr><tr><td style="text-align: center;" rowspan="4" class="confluenceTd">Python<br/><br/><br/></td><td class="confluenceTd">2.7</td><td class="confluenceTd">python2.7</td></tr><tr><td class="confluenceTd">3.5</td><td class="confluenceTd">python3.5</td></tr><tr><td class="confluenceTd">3.6</td><td class="confluenceTd">python3.6</td></tr><tr><td class="confluenceTd">3.7</td><td class="confluenceTd">python3.7</td></tr><tr><td style="text-align: center;" rowspan="2" class="confluenceTd">Java</td><td colspan="1" class="confluenceTd">8</td><td colspan="1" class="confluenceTd">java</td></tr><tr><td colspan="1" class="confluenceTd">11</td><td colspan="1" class="confluenceTd">not available</td></tr><tr><td style="text-align: center;" colspan="1" class="confluenceTd">Go</td><td colspan="1" class="confluenceTd"><span style="color: rgb(32,33,36);">1.12</span></td><td colspan="1" class="confluenceTd">go</td></tr></tbody></table></div><h1 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-Commands">Commands</h1><p>This section describes the commands that are used to build, publish, run tests and examples for the images.</p><h3 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-Prerequisites">Prerequisites</h3><p>Docker should be installed.</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>confirm docker is installed</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: true; theme: Default" data-theme="Default">$ docker -v
Docker version 18.09.3, build 774a1f4</pre>
</div></div><h3 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-Runatestagainstcontainers">Run a test against containers</h3><p><em><strong><span style="color: rgb(153,51,0);">This is the last part of release process, at this moment, we already finished release validation, do we need to run tests against container again which is generated from the already validated code?</span></strong></em></p><h4 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-Runningprecommittestsatlocal">Running precommit tests at local</h4><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Python</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: true; theme: Default" data-theme="Default">$ ./gradlew :sdks:python:test-suites:portable:py2:preCommitPy2
$ ./gradlew :sdks:python:test-suites:portable:py35:preCommitPy35
$ ./gradlew :sdks:python:test-suites:portable:py35:preCommitPy36
$ ./gradlew :sdks:python:test-suites:portable:py35:preCommitPy37</pre>
</div></div><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Java</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: true; theme: Default" data-theme="Default">$ ./gradlew :javaPreCommitPortabilityApi --continue --info</pre>
</div></div><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Go</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: true; theme: Default" data-theme="Default">$ ./gradlew :goPreCommit</pre>
</div></div><p><code> </code></p><h4 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-Runpostcommittestsatlocal">Run postcommit tests at local</h4><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Python</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: true; theme: Default" data-theme="Default">$ ./gradlew :python2PostCommit
$ ./gradlew :python35PostCommit
$ ./gradlew :python36PostCommit
$ ./gradlew :python37PostCommit</pre>
</div></div><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Java</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: true; theme: Default" data-theme="Default">$ ./gradlew :javaPostCommitPortabilityApi --continue --info</pre>
</div></div><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Go</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: true; theme: Default" data-theme="Default">$ ./gradlew :goPostCommit</pre>
</div></div><h3 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-PublishimagestoGCR">Publish images to GCR</h3><p>Publishing images to gcr.io/beam requires permissions in apache-beam-testing project.</p><p>Please note this will create new images (not used for above testings). Since they are created from the same code, we assume the images are exactly the same.</p><p><strong>Set repository and tag as variables:</strong></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>For snapshot</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: true; theme: Default" data-theme="Default">export REPOSITORY=gcr.io/apache-beam-testing/beam/sdk/snapshot/`date +&quot;%Y/%m/%d&quot;`
export TAG=`date +&quot;%Y%m%d&quot;`</pre>
</div></div><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>For release</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: true; theme: Default" data-theme="Default">export REPOSITORY=gcr.io/apache-beam-testing/beam/sdk/release
export TAG=2.15.0</pre>
</div></div><p><strong>To build and push docker images run:</strong></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Python</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: true; theme: Default" data-theme="Default">$ pwd
[...]/beam/
$ ./gradlew :sdks:python:container:py2:dockerPush  -Pdocker-repository-root=$REPOSITORY -Pdocker-tag=$TAG --info
$ ./gradlew :sdks:python:container:py35:dockerPush -Pdocker-repository-root=$REPOSITORY -Pdocker-tag=$TAG --info
$ ./gradlew :sdks:python:container:py36:dockerPush -Pdocker-repository-root=$REPOSITORY -Pdocker-tag=$TAG --info
$ ./gradlew :sdks:python:container:py37:dockerPush -Pdocker-repository-root=$REPOSITORY -Pdocker-tag=$TAG --info
</pre>
</div></div><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Java</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: true; theme: Default" data-theme="Default">$ ./gradlew :sdks:java:container:dockerPush -Pdocker-repository-root=$REPOSITORY -Pdocker-tag=$TAG --info</pre>
</div></div><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Go</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: true; theme: Default" data-theme="Default">$ ./gradlew :sdks:go:container:dockerPush -Pdocker-repository-root=$REPOSITORY -Pdocker-tag=$TAG --info</pre>
</div></div><h1 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-ReleaseImagesValidation">Release Images Validation</h1><p>This section describes how to validate a built and/or published image.</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Make sure the images are pullable</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: true; theme: Default" data-theme="Default">$ docker pull $REPOSITORY/python2.7:$TAG
$ docker pull $REPOSITORY/java:$TAG
$ docker pull $REPOSITORY/go:$TAG</pre>
</div></div><h3 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-Automatedtestsuites">Automated test suites</h3><p>We have these test suites in Beam that utilize portability:</p><ul><li>precommit tests</li><li>postcommit tests</li></ul><p>*These tests will use default images, not the one pushed to gcr.</p><h3 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-Manualtesting"><span style="color: rgb(0,0,0);">Manual testing</span></h3><p><span style="color: rgb(0,0,0);">Test on Dataflow with uploaded images.</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Python</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: true; theme: Default" data-theme="Default"># this should run againest py2.7, py3.5, py3.6 and py3.7.
$ pwd
[...]beam/sdks/python
$ python -m apache_beam.examples.wordcount \
  --input gs://apache-beam-samples/shakespeare/hamlet.txt \
  --output gs://temp-storage-for-end-to-end-tests/staging-$USER/output \
  --runner DataflowRunner \
  --project apache-beam-testing \
  --temp_location gs://temp-storage-for-end-to-end-tests/staging-$USER/ \
  --worker_harness_container_image $REPOSITORY/python2.7:$TAG \
  --experiment beam_fn_api \
  --sdk_location sdks/python/container/py2/build/target/apache-beam.tar.gz</pre>
</div></div><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Java</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: true; theme: Default" data-theme="Default">// get WordCount example code as a maven project
$ mvn archetype:generate \
      -DarchetypeGroupId=org.apache.beam \
      -DarchetypeArtifactId=beam-sdks-java-maven-archetypes-examples \
      -DarchetypeVersion=2.6.0 \
      -DgroupId=org.example \
      -DartifactId=word-count-beam \
      -Dversion=&quot;0.1&quot; \
      -Dpackage=org.apache.beam.examples \
      -DinteractiveMode=false

// run Java project
$ pwd
[...]/word-count-beam
$ mvn compile exec:java -Dexec.mainClass=org.apache.beam.examples.WordCount -Dexec.args=&quot;\
  --runner=DataflowRunner \
  --project=apache-beam-testing \
  --stagingLocation=gs://temp-storage-for-end-to-end-tests/staging-$USER/ \
  --workerHarnessContainerImage=$REPOSITORY/java:$TAG \
  --experiments=beam_fn_api \
  --output=gs://temp-storage-for-end-to-end-tests/staging-$USER/output&quot; \
  -Pdataflow-runner</pre>
</div></div><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Go</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: true; theme: Default" data-theme="Default">$ pwd
[...]/beam/sdks/go
$ go run examples/wordcount/wordcount.go \
--runner=dataflow \
--project=apache-beam-testing \
--staging_location=gs://temp-storage-for-end-to-end-tests/staging-$USER/  \
--worker_harness_container_image=$REPOSITORY/go:$TAG \
--output=gs://temp-storage-for-end-to-end-tests/staging-$USER/output</pre>
</div></div><h3 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-Backwardscompatibility">Backwards compatibility</h3><ul><li>Do we want new images to be able to run old pipelines?<ul><li>This is decided by SDK, not container specific.</li></ul></li><li>How long do we support backwards compatibility for?<ul><li>This is decided by SDK, not container specific.</li></ul></li></ul><h3 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-Otherverification">Other verification</h3><ul><li>Do we sign the artifacts, images?<ul><li>??</li></ul></li><li>Do we check hashes, signatures?<ul><li>No</li></ul></li></ul><h1 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-SupportStory">Support Story</h1><p><strong>How do we allow the images to be used?</strong></p><ol><li>Snapshot images can be used for daily testing.</li><li><span style="color: rgb(32,33,36);">Snapshot images are always created from head, so users can use Beam at head if they want to.</span></li><li><span style="color: rgb(32,33,36);">Customize containers on top of published images.</span></li><li><span style="color: rgb(32,33,36);">...</span></li></ol><p><strong>Do we support users using them in production as is?</strong></p><p>Release images can be used in production. Snapshot images can be used in production, but we don't guarantee they are as stable as release images. </p><p><strong>Is there some quota for downloading the prebuilt images?</strong></p><p>From <a class="external-link" href="https://cloud.google.com/container-registry/quotas" rel="nofollow">gCloud instruction</a>, gcr has following quota limitations.</p><div class="confluence-information-macro has-no-icon confluence-information-macro-information conf-macro output-block" data-hasbody="true" data-macro-name="info"><div class="confluence-information-macro-body"><p>Any request sent to Container Registry has a 2 hour timeout limit.</p><p>The fixed rate limits per client IP address are:</p><ul><li>30,000 HTTP requests every 10 minutes</li><li>500,000 HTTP requests per day</li></ul><p>Container Registry uses Cloud Storage for each registry's underlying storage.<span> </span><a class="external-link" href="https://cloud.google.com/storage/quotas" rel="nofollow" style="text-decoration: none;">Cloud Storage Quotas &amp; Limits</a><span> </span>apply to each registry.</p></div></div><p><br/></p><p><strong>Any special/extra license needs to be attached to the images?</strong></p><p><br/></p><h1 id="id-[WIP]SDKHarnessContainerImageReleaseProcess-Reportbugs"><strong>Report bugs</strong></h1><ul><li><strong>If something goes wrong with the release process:</strong><ul><li>ping dev@ </li></ul></li><li><strong>If something goes wrong with a customer pipeline from using the prebuilt images:</strong><ul><li>ping dev@ </li></ul></li></ul><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p>