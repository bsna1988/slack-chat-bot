<p>The Apache Beam project maintains a set of performance tests running on a regular basis on Jenkins (see: <a href="https://cwiki.apache.org/confluence/display/BEAM/Contribution+Testing+Guide#ContributionTestingGuide-TestsofCoreApacheBeamOperations" rel="nofollow">Load Tests</a>, <a href="https://cwiki.apache.org/confluence/display/BEAM/Running+Nexmark" rel="nofollow">Nexmark</a> and <a class="external-link" href="https://ci-beam.apache.org/view/PerformanceTests/" rel="nofollow">Performance Tests</a>). Their results are sent to time series database, which is InfluxDB, and displayed using Grafana. Dashboards are available at: <a class="external-link" href="http://metrics.beam.apache.org" rel="nofollow">http://metrics.beam.apache.org</a>.</p><p><br/></p><p><div class="toc-macro client-side-toc-macro  conf-macro output-block" data-hasbody="false" data-headerelements="H1,H2,H3,H4,H5,H6,H7" data-macro-name="toc"> </div></p><h1 id="TestResultsMonitoring-Resources">Resources</h1><ul><li><a class="external-link" href="http://metrics.beam.apache.org" rel="nofollow">Grafana dashboards</a></li><li>Design docs:<ul><li><a class="external-link" href="https://s.apache.org/test-metrics-storage-corrected" rel="nofollow">Storing, displaying and detecting anomalies in test results</a></li></ul></li><li>Source code: <a class="external-link" href="https://github.com/apache/beam/tree/master/.test-infra/metrics" rel="nofollow">.test-infra/metrics</a></li></ul><p><br/></p><p>Local development and deployment is managed by docker-compose, while the production environment is deployed via Kubernetes.</p><p>Instructions for developing and making updates to dashboards are checked-in: <a class="external-link" href="https://github.com/apache/beam/blob/master/.test-infra/metrics/README.md" rel="nofollow">README.md</a>. Instructions for deploying the stack to a production environment are below.</p><h1 id="TestResultsMonitoring-Kubernetesdeployment">Kubernetes deployment</h1><h2 id="TestResultsMonitoring-FirstTimePrep">First Time Prep</h2><p>Configure gcloud &amp; kubectl: <a class="external-link" href="https://cloud.google.com/kubernetes-engine/docs/quickstart" rel="nofollow">https://cloud.google.com/kubernetes-engine/docs/quickstart</a></p><ul><li>In particular, either set the default project and compute zone to match <code>apache-beam-testing</code> and the <code>metrics</code> cluster, or remember to use those as parameters in the steps below.</li></ul><h2 id="TestResultsMonitoring-Deploytheinfrastructure">Deploy the infrastructure</h2><h3 id="TestResultsMonitoring-InfluxDB">InfluxDB</h3><p>Before deploying the infrastructure, make sure the cluster has <strong>storage-rw </strong>access scope. This scope grants write access to all Cloud Storage resources and is required for automatic backups to work properly.</p><p>Execute the following from the <code>.test-infra/metrics</code> directory of the Apache Beam repository:</p><ul><li>Add secrets for InfluxDB: <code>kubectl create secret generic influxdb-creds --from-literal=INFLUXDB_USER=&lt;user&gt; --from-literal=INFLUXDB_USER_PASSWORD=&lt;pwd&gt; --from-literal=INFLUXDB_ADMIN_USER=&lt;user&gt; --from-literal=INFLUXDB_ADMIN_PASSWORD=&lt;pwd&gt;.</code> Important: keep the name of a user and the password in sync with Jenkins credentials, otherwise there might be problems with sending test results.</li><li>Create persistent volume claims:</li></ul><pre>kubectl create -f beam-influxdb-storage-persistentvolumeclaim.yaml
kubectl create -f beam-influxdb-backups-persistentvolumeclaim.yaml</pre><ul><li>Create deployment and services: <code>kubectl create -f beam-influxdb.yaml</code></li><li>Create cron job for automated backups: <code>kubectl create -f beam-influxdb-autobackup.yaml</code></li></ul><p><br/></p><p>The administator and the user account as well as a new database called <strong>beam-test-metrics</strong> will be automatically created.</p><h3 id="TestResultsMonitoring-Grafana">Grafana</h3><p>Refer to <a href="/confluence/display/BEAM/Community+Metrics">Community Metrics</a> for details on how to deploy Grafana.</p><h2 id="TestResultsMonitoring-Restorefromabackup">Restore from a backup</h2><p>A full database backup is being made once a day and written to GCS bucket at <strong>gs://apache-beam-testing-metrics/</strong>. The bucket has the following policies enabled:</p><ul><li>object versioning,</li><li>a lifecycle rule that keeps only the 14 most recent versions of the backup.</li></ul><p>The bucket is readable to everyone on the Internet.</p><p><br/></p><p>If something goes wrong, it is possible to restore database from a backup. Before getting started, make sure the pod with InfluxDB is operational.</p><ol><li>Start InfluxDB CLI and authenticate yourself. Instructions are below, in the Maintenance section.</li><li>Check that the database to be restored from the backup does not exist by executing <strong>show databases </strong>command.</li><li>Leave the CLI and run the following command from within the pod:</li></ol><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">influxd restore -portable /path/to/backup</pre>
</div></div><p>Do note that this will not restore users and their permissions! In case of disaster, these data must be recreated manually.</p><p><br/></p><h1 id="TestResultsMonitoring-Maintenance">Maintenance</h1><p>Normally, if developing new Grafana dashboards or testing SQL queries, you don't need to connect to the production instance of InfluxDB. These tips are indened only for maintenance work.</p><p>Before getting started, make sure that you have gcloud and kubectl configured. Appropriate permissions for apache-beam-testing project will also be needed.</p><h3 id="TestResultsMonitoring-HowcanIuseInfluxDBcommandlineinterface?">How can I use InfluxDB command line interface?</h3><p><br/></p><p>First, obtain the name of the admin user and the password:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">kubectl get secret influxdb-creds -o yaml</pre>
</div></div><p>YAML values of secret data are encoded as base64 strings. Use the following command to decode data:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">echo '&lt;secret-data&gt;' | base64 --decode </pre>
</div></div><p><br/></p><p class="auto-cursor-target">The next step is to run an interactive bash session in the pod. Find the name of the pod that runs InfluxDB:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">kubectl get pods</pre>
</div></div><p class="auto-cursor-target">The name of the pod starts with &quot;influxdb&quot;. Use the full name to execute a command:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">kubectl exec -it influxdb-67c6bcf57b-w672w -- bash</pre>
</div></div><p class="auto-cursor-target">Then start the CLI with the command <strong>influx</strong>. The CLI indicates readiness to accept commands with &quot;&gt;&quot; prompt. Execute <strong>auth </strong>command to authenticate yourself with the admin credentials.</p><p class="auto-cursor-target">For information on how to use InfluxDB command line interface, see: <a class="external-link" href="https://docs.influxdata.com/influxdb/v1.8/tools/shell/" rel="nofollow">https://docs.influxdata.com/influxdb/v1.8/tools/shell/</a>.</p><h3 class="auto-cursor-target" id="TestResultsMonitoring-HowcanIsendHTTPrequeststoInfluxDB?">How can I send HTTP requests to InfluxDB?</h3><p>We are using <a class="external-link" href="https://cloud.google.com/kubernetes-engine/docs/how-to/internal-load-balancing" rel="nofollow">Internal Load Balancing</a> to make InfluxDB accessible outside of Kubernetes cluster. Internal Load Balancing creates an internal IP address that receives traffic from clients in the same VPC network and compute region. This means that you are not allowed to connect to InfluxDB from your workstation unless you set up a port forwarding over SSH.</p><p>To learn how to use a port forwarding, see <a class="external-link" href="https://cloud.google.com/solutions/connecting-securely#port-forwarding-over-ssh" rel="nofollow">https://cloud.google.com/solutions/connecting-securely#port-forwarding-over-ssh</a>.</p><p>Find the IP address by executing the following command:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">kubectl get service influxdb</pre>
</div></div><p>The IP address and the port can be found in the EXTERNAL-IP and PORT(S) columns, respectively.</p><p>Having all the information needed, run the following command to set up a port forwarding:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">gcloud compute ssh example-instance --project apache-beam-testing --zone us-central1-a -- -L 8086:&lt;EXTERNAL-IP&gt;:&lt;PORT&gt;</pre>
</div></div><p><br/></p><h3 id="TestResultsMonitoring-HowcanIincreasestorageofInfluxDB?">How can I increase storage of InfluxDB?</h3><p>Open a cloud-shell session and execute:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">kubectl edit pvc influxdb-storage</pre>
</div></div><p>Then increase the resources.requrests.storage field, save and exit, the change should take effect a moment later.</p>