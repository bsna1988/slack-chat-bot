<p><span>Below you can find the most Frequently Asked Questions asked about the testing infrastructure and performance tests in Beam. </span></p><p><span><div class="toc-macro client-side-toc-macro  conf-macro output-block" data-hasbody="false" data-headerelements="H1,H2,H3,H4,H5,H6,H7" data-macro-name="toc"> </div></span></p><h2 id="BeamTestingToolsFAQ-DowehaveacommonGCPprojectfortestingpurposes?"><span>Do we have a common GCP project for testing purposes?</span></h2><p><span>Yes. Beam has a dedicated GCP project with &quot;apache-beam-testing&quot; id. It is currently used to run Google Cloud Dataflow jobs, host testing infrastructure (Google Cloud Storage, Google Kubernetes Engine, Google Cloud Dataproc), store metrics (BigQuery) or host dashboards of any kind (</span><a class="external-link" href="https://s.apache.org/beam-community-metrics" rel="nofollow"><span>community metrics dashboards</span></a><span>, </span><a class="external-link" href="https://apache-beam-testing.appspot.com/" rel="nofollow"><span>performance tests dashboards</span></a><span>).  </span></p><h2 id="BeamTestingToolsFAQ-HowdoIsetupaFlinkclusterforBeamtests?WherecanIfindthescriptstodothis?"><span>How do I set up a Flink cluster for Beam tests? Where can I find the scripts to do this?</span></h2><p><span>There's a Google Cloud Dataproc setup available that you might find interesting. It consists of several bash &quot;init actions&quot; that install necessary software (flink, docker) on virtual machines. There's also a &quot;flink_setup.sh&quot; script that let's you bootstrap the whole cluster without digging into it's implementation details. See </span><a class="external-link" href="https://github.com/apache/beam/blob/b325bd748c6a07dc4fcc07ed5f30f9cbda55ad0a/.test-infra/dataproc/flink_cluster.sh" rel="nofollow"><span>flink_setup.sh</span></a><span> for running instructions.</span></p><h2 id="BeamTestingToolsFAQ-HowdoIsetupadatabaseorafilesystemforBeamintegrationtests?WherecanIfindthescriptstodothiseasily?"><span>How do I set up a database or a file system for Beam integration tests? Where can I find the scripts to do this easily?</span></h2><p><span>The easiest way to set up a database or file system for testing purposes is to use Kubernetes. It lets you set up and teardown databases/file systems easily in an isolated way so that you could use it in your tests without worrying that it will be a shared resource or that it will contain some &quot;garbage&quot; data from previous runs. </span></p><p><span>There are several scripts in Beam's repo to set up various kinds of datastores and use them in tests on a daily basis. You can find them in </span><a class="external-link" href="https://github.com/apache/beam/tree/master/.test-infra/kubernetes" rel="nofollow"><span>.test-infra/kubernetes</span></a><span> folder. If you want to use them, you might find </span><a class="external-link" href="https://github.com/apache/beam/blob/master/.test-infra/kubernetes/kubernetes.sh" rel="nofollow"><span>kubernetes.sh</span></a><span> script useful (it decorates common kubectl operations and setups the datastore in its own namespace - this may be handy, especially on Jenkins).</span></p><h2 id="BeamTestingToolsFAQ-Whatrunnersetupsareavailable?"><span>What runner setups are available?</span></h2><p><span>At the state of writing (25 November 2019) we have proven to successfully run tests on the following infrastructure: </span></p><ul><li><span>portable Flink jobs using Dataproc Flink setup</span></li><li><span>non-portable Flink jobs using the same Dataproc Flink setup</span></li><li><span>non-portable Dataflow jobs</span></li><li><span>non-portable Direct runner jobs</span></li></ul><h2 id="BeamTestingToolsFAQ-HowdoIcollectruntimemetricsfrommytestingpipeline?"><span>How do I collect runtime metrics from my testing pipeline?</span></h2><p><span>You can use Metrics API and distribution metric to do that. We've created special DoFns that can be attached in any place in between the other transforms of the pipeline to collect execution time. After collecting the metric we can get min() and max() value from it and subtract those to get the execution time of a job.</span></p><p><span>See:</span></p><ul><li><span> </span><a class="external-link" href="https://github.com/apache/beam/blob/b446304f75078ca9c97437e685409c31ceab7503/sdks/java/io/file-based-io-tests/src/test/java/org/apache/beam/sdk/io/text/TextIOIT.java#L124" rel="nofollow"><span>TextIOIT</span></a><span> or any IOIT for the usage example.</span></li><li><span>Java SDK: </span><a class="external-link" href="https://github.com/apache/beam/blob/master/sdks/java/testing/test-utils/src/main/java/org/apache/beam/sdk/testutils/metrics/TimeMonitor.java" rel="nofollow"><span>TimeMonitor.java</span></a></li><li><span>Python SDK: </span><a class="external-link" href="https://github.com/apache/beam/blob/1988284a89b10b60eea48325f8a3b370b551c77c/sdks/python/apache_beam/testing/load_tests/load_test_metrics_utils.py#L406" rel="nofollow"><span>MeasureTime.py</span></a></li></ul><p><span>In the future, it might be worth to utilize portable system metrics for the jobs. Ticket for the investigation: </span><a class="external-link" href="https://issues.apache.org/jira/browse/BEAM-8826" rel="nofollow"><span>BEAM-8826</span></a></p><h2 id="BeamTestingToolsFAQ-Wheredowestoremetricscollectedfromperiodicallyrunningtests(i.e.Jenkinsjobs)?"><span>Where do we store metrics collected from periodically running tests (i.e. Jenkins jobs)?</span></h2><p><span>Currently, all collected metrics can be stored in a BigQuery database hosted in an apache-beam-testing GCP project. You can use special helper classes to save your test results: </span></p><ul><li><span>Java SDK: </span><a class="external-link" href="https://github.com/apache/beam/blob/master/sdks/java/testing/test-utils/src/main/java/org/apache/beam/sdk/testutils/publishing/BigQueryResultsPublisher.java" rel="nofollow"><span>BigQueryResultsPublisher.java</span></a></li><li><span>Python SDK: </span><a class="external-link" href="https://github.com/apache/beam/blob/1988284a89b10b60eea48325f8a3b370b551c77c/sdks/python/apache_beam/testing/load_tests/load_test_metrics_utils.py#L195" rel="nofollow"><span>MetricsReader.py</span></a></li></ul><h2 id="BeamTestingToolsFAQ-HowtoaddanewJenkinsjobforrunningtests?"><span>How to add a new Jenkins job for running tests?</span></h2><p><span>You can add a new job definition using Jenkins </span><a class="external-link" href="https://jenkinsci.github.io/job-dsl-plugin/" rel="nofollow"><span>job DSL</span></a><span> and helper classes located in </span><a class="external-link" href="https://github.com/apache/beam/tree/master/.test-infra/jenkins" rel="nofollow"><span>.test-infra/jenkins</span></a><span> directory. A new job can be added either in existing job_* files or a new one added by you. </span></p><p><span>Please keep in mind that Jenkins </span><strong>does not </strong><span>automatically</span> <span>detect your newly added/modified Jenkins job definitions on your PR branch. To be able to run the new or modified job in a PR you have to reload it using a &quot;seed job&quot; (see below).</span></p><h2 id="BeamTestingToolsFAQ-Whatisa&quot;seedjob&quot;andwhenshouldIinvokeit?"><span>What is a &quot;seed job&quot; and when should I invoke it?</span></h2><p><span>The seed job is a special &quot;meta&quot; job that is used for reloading the existing job configurations. It runs periodically (every 6 hours) or can be started on-demand in a Pull Request (by typing a comment: &quot;Run seed job&quot;). Whenever you add or modify a Jenkins job, you should invoke the seed job in a PR to be able to test it and to see if compiles. </span></p><p><span>Important note: currently our Jenkins jobs configuration is centralized and being held in one place (not per branch - one centralized config). The seed job reloads all jobs. Therefore:</span></p><ul><li><span>Invoking a seed job reload all jobs for all branches including the master branch. To undo the changes that you introduced by running a seed job you can either wait for Jenkins to invoke seed job automatically or run it against master. </span></li><li><span>2 developers modifying the same job files and running seed jobs is a race condition. You've been warned. :) </span></li></ul><h2 id="BeamTestingToolsFAQ-HowtotestJenkinsjobsthatI&#39;mcurrentlydevelopingbeforecreatingaPullRequest?"><span>How to test Jenkins jobs that I'm currently developing before creating a Pull Request?</span></h2><p><span>Although we do not have automatic tests for Jenkins jobs, there's a dockerized Jenkins instance that mimics the Apache's one and can be used for testing a job before submitting a PR. It's an easy way of tracking down all typos or errors in job definitions. You also have admin access in the dockerized instance, so you can see more than you would in Apache's Jenkins. </span></p><p><span>Look for more detailed instructions on how to run and configure the dockerized Jenkins instance in .</span><a class="external-link" href="https://github.com/apache/beam/tree/master/.test-infra/dockerized-jenkins" rel="nofollow"><span>test-infra/dockerized-jenkins</span></a><span>.</span></p><h2 id="BeamTestingToolsFAQ-Arethereanydashboardswithtestmetrics?Wherearethey?"><span>Are there any dashboards with test metrics? Where are they?</span></h2><p><span>We currently use Perfkit Explorer to display dashboards with metrics for load tests, IO tests, and Nexmark suites. You can find them here: </span><a class="external-link" href="https://apache-beam-testing.appspot.com/dashboard-admin" rel="nofollow"><span>https://apache-beam-testing.appspot.com/dashboard-admin</span></a></p><h2 id="BeamTestingToolsFAQ-HowdoIaddanewdashboardformytests?"><span>How do I add a new dashboard for my tests?</span></h2><p><span>Just click &quot;create&quot; in the dashboard administrator. </span></p><p><span>For more info see </span><a class="external-link" href="https://github.com/GoogleCloudPlatform/PerfKitExplorer" rel="nofollow"><span>PerfKitExplorer docs</span></a><span> and the demo project in particular (</span><span><a class="external-link" href="https://perfkit-explorer.appspot.com/explore?dashboard=5714163003293696" rel="nofollow">Perfkit Explorer demo</a>)</span><span>.</span></p><h2 id="BeamTestingToolsFAQ-Isthereanyanomalydetectionmechanismtoautomaticallydetectregressions/improvements?"><span>Is there any anomaly detection mechanism to automatically detect regressions/improvements? </span></h2><p><span>No. Currently, we do not detect anomalies in an automated fashion. We do it manually by looking at the graphs in PerfkitExplorer. </span></p><p><span>Note that we're planning to change it. We introduced a proposal to use Grafana + InfluxDb + Kapacitor stack. This setup will allow us to define alerts, trigger them via slack + email. Moreover, the goal is to keep the above as code (infrastructure as code approach).</span></p><p><span>Link to the proposal: </span><a class="external-link" href="https://s.apache.org/test-metrics-storage-corrected" rel="nofollow"><span>https://s.apache.org/test-metrics-storage-corrected</span></a></p><h2 id="BeamTestingToolsFAQ-WhatkindsofperformancetestsdowehaveinBeam?"><span>What kinds of performance tests do we have in Beam?</span></h2><p><span>Most notable examples of performance test types that we currently have continuously running in Beam are:</span></p><ul><li><a class="external-link" href="https://beam.apache.org/documentation/io/testing/#i-o-transform-integration-tests" rel="nofollow"><span>IO transform integration tests</span></a></li><li><a class="external-link" href="https://beam.apache.org/documentation/sdks/java/testing/nexmark/" rel="nofollow"><span>Nexmark suites</span></a></li><li><a href="https://cwiki.apache.org/confluence/display/BEAM/Contribution+Testing+Guide#ContributionTestingGuide-TestsofCoreApacheBeamOperations" rel="nofollow"><span>Tests of Core Apache Beam Operations</span></a></li></ul><p><span>Other than that, please see the </span><a href="https://cwiki.apache.org/confluence/display/BEAM/Contribution+Testing+Guide" rel="nofollow"><span>Contribution Testing Guide</span></a><span> in general.</span></p><h2 id="BeamTestingToolsFAQ-CanIwriteacustomtestingpipelinethatdoesnotfitinthecategoriesofteststhatwehavesofar?"><span>Can I write a custom testing pipeline that does not fit in the categories of tests that we have so far?</span></h2><p><span>Yes! All the infrastructure/framework that is there in Beam does not impose any opinionated way of creating tests. It is up to you how you want to write your tests. If any of the building blocks we provided is helpful to you that's great! :)</span></p><h2 id="BeamTestingToolsFAQ-WherecanIfindvideoresourcestolearnaboutintegration/performancetestinginBeam?"><span>Where can I find video resources to learn about integration/performance testing in Beam?</span></h2><p><span>There's a presentation from Warsaw Apache Beam Meetup that is a great intro to what tools we have in Beam for testing purposes (starts at: 1:05:15): </span></p><p><br/></p><p><iframe allowfullscreen="" class="youtube-player conf-macro output-block" data-hasbody="false" data-macro-name="widget" frameborder="0" mozallowfullscreen="" src="//www.youtube.com/embed/8pGDMKfHFBk?wmode=opaque" style="width: 640px; height: 385px" type="text/html" webkitallowfullscreen="">
</iframe>
    
</p><p><br/></p><p><br/></p><p><br/></p><p><br/></p>