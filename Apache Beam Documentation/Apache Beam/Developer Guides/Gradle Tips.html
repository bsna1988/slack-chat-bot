<p><a class="external-link" href="https://docs.gradle.org/" rel="nofollow" style="letter-spacing: 0.0px;">Gradle</a><span style="letter-spacing: 0.0px;"> build files are written using </span><a class="external-link" href="http://groovy-lang.org/" rel="nofollow" style="letter-spacing: 0.0px;">Apache Groovy</a><span style="letter-spacing: 0.0px;">.</span></p><p><div class="toc-macro client-side-toc-macro  conf-macro output-block" data-hasbody="false" data-headerelements="H1,H2,H3,H4,H5,H6,H7" data-macro-name="toc"> </div></p><h2 id="GradleTips-GradleDependencyConfiguration">Gradle Dependency Configuration</h2><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/></colgroup><tbody><tr><th class="confluenceTh">Color</th><th class="confluenceTh">Purpose</th></tr><tr><td class="confluenceTd">Gray Text</td><td class="confluenceTd">Removed in Gradle 7.0</td></tr><tr><td class="confluenceTd">Light Green</td><td class="confluenceTd">Used to declare dependencies</td></tr><tr><td class="confluenceTd">Blue Gray</td><td class="confluenceTd">Consumed by tasks to create dependency set/classpath</td></tr><tr><td class="confluenceTd">Light Blue</td><td class="confluenceTd">Task</td></tr></tbody></table></div><p>Main source set</p><p><span class="confluence-embedded-file-wrapper"><img class="confluence-embedded-image" draggable="false" src="/confluence/download/attachments/95653379/main_source_set.png?version=1&amp;modificationDate=1643744227000&amp;api=v2" data-image-src="/confluence/download/attachments/95653379/main_source_set.png?version=1&amp;modificationDate=1643744227000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="199533575" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="main_source_set.png" data-base-url="https://cwiki.apache.org/confluence" data-linked-resource-content-type="image/png" data-linked-resource-container-id="95653379" data-linked-resource-container-version="24" alt=""></span></p><p><br/></p><p>Test source set</p><p><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" draggable="false" height="400" src="/confluence/download/attachments/95653379/test_source_set.png?version=1&amp;modificationDate=1643744243000&amp;api=v2" data-image-src="/confluence/download/attachments/95653379/test_source_set.png?version=1&amp;modificationDate=1643744243000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="199533576" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="test_source_set.png" data-base-url="https://cwiki.apache.org/confluence" data-linked-resource-content-type="image/png" data-linked-resource-container-id="95653379" data-linked-resource-container-version="24" alt=""></span></p><p>Note that the testRuntimeConfiguration was added to the default set of Java Gradle configurations to simulate the testRuntime configuration by Gradle 6.x and earlier.</p><h2 id="GradleTips-GradleTestsParallelization">Gradle Tests Parallelization</h2><p>The build is configured to run on a given number of workers that are responsible for all the tasks of the build (running tests, compiling code, checkstyle, findbugs, ...)</p><p>Gradle is configured with the <em>forkEvery</em> parameter to run <strong>test classes</strong> in parallel among the gradle workers.</p><p>Each gradle worker uses a single JVM. Inside it, tests are run in sequence. Tests inside a test class are not run in parallel unless you specify a JUnit parallelized runner.</p><p><br/></p><p><span style="font-size: 20.0px;letter-spacing: 0.0px;">Specifying build targets</span></p><p>Gradle targets can be specified with either the project name or directory, for example:</p><pre class="highlight"><code>$ ./gradlew :website:serveWebsite
</code></pre><p>is the same as</p><pre class="highlight"><code>$ ./gradlew -p website serveWebsite
</code></pre><p>The mapping of directory to project name is in <a class="external-link" href="https://github.com/apache/beam/blob/master/settings.gradle" rel="nofollow">settings.gradle</a></p><h2 id="GradleTips-CodeCoverage">Code Coverage</h2><p>Because of issues with the Jacoco plugin, it is disabled unless explicitly requested. And if you request a report, you must <em>also</em> request the tests to report on, like so:</p><pre>./gradlew -p sdks/java/extensions/sql test jacocoTestReport</pre><h2 id="GradleTips-Troubleshootingbuildissues">Troubleshooting build issues</h2><p>You can increase the log level of the build with command-line flags:</p><ul><li><code class="highlighter-rouge">--info</code> flag adds verbose logging</li><li><code class="highlighter-rouge">--stacktrace</code> flag adds a stacktrace on failures</li><li><code class="highlighter-rouge">--scan</code> flag creates a <a class="external-link" href="https://guides.gradle.org/creating-build-scans/" rel="nofollow">Gradle Build Scan</a></li></ul><p><br/></p><p>There are also various built-in tasks useful for introspecting components of the build:</p><ul><li><strong><code>projects</code></strong>: Lists all projects in present in the build</li><li><strong><code>tasks</code></strong>: Displays tasks runnable from the root project (including those in subprojects)</li><li><strong><code>dependencies</code></strong>: Displays dependencies for a project, for each configuration scope</li><li><strong><code>dependencyInsight --dependency &lt;name&gt; --configuration &lt;name&gt;</code></strong>: Inspect why a dependency exists for a project configuration</li><li><strong><code>properties</code></strong>: Print the properties of a configured project</li><li><strong><code>help --task &lt;taskName&gt;</code></strong>: Display help message for a specific task.</li></ul><h3 id="GradleTips-VisualizingTaskDependencies">Visualizing Task Dependencies</h3><p>Our build uses the <a class="external-link" href="https://github.com/dorongold/gradle-task-tree" rel="nofollow">gradle-task-tree</a> plugin to visualize execution graph task dependencies during the build. This makes it easy to inspect why a task was included and ordering constraints.</p><p>To produce a dependency graph, invoke Gradle with a set of tasks and include <code>taskTree</code> from the same project (i.e. ./gradlew :beam-sdks-java-core:build :beam-sdks-java-core:taskTree). Instead of executing the tasks, the gradle-task-tree plugin will print out an ASCII dependency tree on the commandline.</p><h3 id="GradleTips-TroubleshootingResources">Troubleshooting Resources</h3><ul><li><a class="external-link" href="https://blog.softwaremill.com/my-task-whats-wrong-with-your-gradle-task-82312100c595" rel="nofollow">Blog: My task… what’s wrong with your Gradle task?</a> - Useful to understand how tasks are executed</li></ul><h2 id="GradleTips-Commonbuildlogic">Common build logic</h2><p>Most re-usable steps are in <a class="external-link" href="https://github.com/apache/beam/blob/master/buildSrc/src/main/groovy/org/apache/beam/gradle/BeamModulePlugin.groovy" rel="nofollow">BeamModulePlugin.groovy</a>.</p><p>A common style in the build files for methods with several arguments is to use the <a class="external-link" href="http://docs.groovy-lang.org/docs/groovy-2.5.0-beta-1/html/documentation/#_named_argument_constructor" rel="nofollow">named argument constructor</a> which allows passing a map for names and values, for example:</p><pre class="highlight"><code>class BuildTaskConfiguration {
  String name
  boolean useTestConfig = false
  String baseUrl = ''
  String dockerWorkDir = ''
}

def createBuildTask = {
  BuildTaskConfiguration config = it as BuildTaskConfiguration
...
}

createBuildTask(name:'Local', dockerWorkDir: dockerWorkDir)</code></pre><h2 id="GradleTips-Customizinglocalbuildconfiguration">Customizing local build configuration</h2><p>Our Gradle uses various configuration properties which can be overridden to customize build behavior. These are generally used to set external resource locations for testing, such as Google Cloud project or Docker container registry. You can find useful properties by <a class="external-link" href="https://github.com/apache/beam/search?q=findProperty" rel="nofollow">searching for usages of the Gradle findProperty('..') API</a>.</p><p>You can specify property values for these on the command-line using <strong>-P</strong>. For example, to run Dataflow runner precommit tests with your own GCP settings:</p><blockquote><pre>./gradlew -PgcpProject=myGoogleCloudProject -PgcsBucket=myGoogleCloudStorageBucket \</pre><pre>:runners:google-cloud-dataflow-java:examples:preCommit</pre></blockquote><h3 id="GradleTips-Settingbuildcustomizationsinauserconfigfile">Setting build customizations in a user config file</h3><p>You can also set default Gradle property overrides inside of a user <strong>gradle.properties</strong> file (<a class="external-link" href="https://docs.gradle.org/current/userguide/build_environment.html#sec:gradle_configuration_properties" rel="nofollow">documentation</a>). Create the file in your GRADLE_USER_HOME directory (defaults to ~/.gradle on Mac/Linux). In the file, you can set defaults for any Gradle property from the build:</p><blockquote><pre>gcsProject=myGoogleCloudProject<br/>gcpProject=myGoogleCloudProject<br/>gcsTempRoot=myGoogleCloudStorageBucket<br/>dockerImageRoot=myDockerImageRoot<br/>docker-repository-root=myDockerRepositoryRoot</pre></blockquote><h3 id="GradleTips-CreateBuildScanonfailedbuilds">Create Build Scan on failed builds</h3><p>Another useful customization is to automatically upload a build scan when the build fails. This makes it very easy to share your build results for debugging. To do so, create an <strong>init.d/buildScan.gradle</strong> file in your GRADLE_USER_HOME directory with the following contents (<a class="external-link" href="https://guides.gradle.org/creating-build-scans/#enable_build_scans_for_all_builds_optional" rel="nofollow">documentation</a>):</p><blockquote><pre>initscript {<br/>  repositories {<br/>    gradlePluginPortal()<br/>  }<br/>    dependencies {<br/>    classpath 'com.gradle:build-scan-plugin:2.4.2'<br/>  }<br/>}<br/>rootProject {<br/>  apply plugin: com.gradle.scan.plugin.BuildScanPlugin<br/>  buildScan {<br/>    publishOnFailure()<br/>    termsOfServiceUrl = '<a class="external-link" href="https://gradle.com/terms-of-service" rel="nofollow">https://gradle.com/terms-of-service</a>'<br/>    termsOfServiceAgree = 'yes'<br/>  }<br/>}</pre></blockquote><h2 id="GradleTips-OutOfMemoryExceptionduringtheGradlebuild">OutOfMemoryException during the Gradle build</h2><p><span style="color: rgb(32,33,36);">You may want to have a customized gradle.properties file in GRADLE_USER_HOME, and then setup your environment vars in the shell startup script. </span></p><p><span style="color: rgb(32,33,36);">export GRADLE_USER_HOME=~/.gradle</span></p><p><span style="color: rgb(32,33,36);">source ~/.bashrc</span></p><p><br/></p><p>Update gradle config via editing/creating gradle.properties in root source folder or in GRADLE_USER_HOME (~/.gradle).</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">cat ~/.gradle/gradle.properties 

# Gradle has a tendency to reuse daemons during build.
# Disable daemon usage to avoid OOM.
org.gradle.daemon=false


# By default Beam project is configured to run gradle tests in parallel. Disabling this can reduce max memory usage.
org.gradle.parallel=false


# Increase jvm memory.
org.gradle.jvmargs=-Xmx2g -XX:MaxPermSize=512m</pre>
</div></div><h2 id="GradleTips-PublishamodulesnapshotreleasetomavenLocal">Publish a module snapshot release to mavenLocal</h2><p>For local testing, a module can be published to mavenLocal. E.g. for the kafka module:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Default" data-theme="Default">./gradlew -Ppublishing -PdistMgmtSnapshotsUrl=~/.m2/repository/ -p sdks/java/io/kafka publishToMavenLocal</pre>
</div></div><p>If the local maven repository isn't in the default path of <code>~/.m2/repository/</code> then it can be replaced with a custom path like the following: <code><span class="nolink"><span class="nolink">file:///path/to/custom/maven/repo</span></span></code></p><p>Once a snapshot version of Beam has been built, you must depend on that snapshot when running pipelines. See the snippet below for an example of how to use the snapshot as a dependency in Gradle. For more info see<span style="color: rgb(0,0,0);"> </span><a class="external-link" href="https://docs.gradle.org/current/userguide/declaring_repositories.html" rel="nofollow"><span style="color: rgb(17,85,204);">the Gradle documentation</span></a><span style="color: rgb(0,0,0);">.</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: groovy; gutter: false; theme: Default" data-theme="Default">repositories {
   maven {
       url &quot;file:///path/to/custom/maven/repo&quot;
   } // Use this when using a non-default local repo.
   mavenLocal() // Use this with the default local repo.
   mavenCentral()
}

dependencies {
   implementation &quot;org.apache.beam:beam-sdks-java-io-kafka:2.23.0-SNAPSHOT&quot;
}</pre>
</div></div><h2 id="GradleTips-Publishavendoreddependencylocally">Publish a vendored dependency locally</h2><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">./gradlew -p vendor/bytebuddy-1_10_8 -PisRelease -Psigning.gnupg.keyName=apache.org -PvendoredDependenciesOnly publishToMavenLocal</pre>
</div></div><p>You can find this and more details in the <a class="external-link" href="https://s.apache.org/beam-release-vendored-artifacts" rel="nofollow">vendored dependencies release guide</a>.</p><h2 id="GradleTips-CopyingTestResourcesAcrossGradleProjects">Copying Test Resources Across Gradle Projects</h2><p class="auto-cursor-target">For tests run in one project (e.g. integration tests run by <code>:sdks:java:io:google-cloud-platform</code>) that run tests defined in another (e.g.<code> :runners:google-cloud-dataflow-java</code>) your tests may depend on resources (canonically in<code> src/test/resources</code> of that source tree).<br/>To add these files to the <code>build.gradle</code> to include a copy task to get files from one project to another.</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: groovy; gutter: true; first-line: 1; theme: Default" data-theme="Default">task copyGoogleCloudPlatformTestResources(type: Copy){
  from project(':sdks:java:io:google-cloud-platform').fileTree(&quot;src/test/resources&quot;)
  into &quot;$buildDir/resources/test/&quot;
}

task googleCloudPlatformLegacyWorkerIntegrationTest(type: Test, dependsOn: copyGoogleCloudPlatformTestResources) {
  ...}</pre>
</div></div>