<p><div class="toc-macro client-side-toc-macro  conf-macro output-block" data-hasbody="false" data-headerelements="H1,H2" data-macro-name="toc"> </div></p><h1 id="JenkinsTips-Highlights">Highlights</h1><p>The location<code> ./test-infra/jenkins</code> contains the defined Jenkins jobs are defined in  These jobs are written using the <a class="external-link" href="https://jenkinsci.github.io/job-dsl-plugin/" rel="nofollow">Job DSL</a> using <a class="external-link" href="http://groovy-lang.org/" rel="nofollow">Apache Groovy</a>. Job definitions should be a simple as possible and ideally identify a single Gradle target to execute.</p><h1 id="JenkinsTips-TestingChanges">Testing Changes</h1><p>The following are some Testing Changes tips that could help you:</p><ul><li>Use <a class="external-link" href="https://github.com/apache/beam/tree/master/.test-infra/dockerized-jenkins" rel="nofollow">Local Dockerized Jenkins</a> to test changes locally without breaking the project’s job definitions. </li><li>Test a PR that includes Jenkins changes, but it is <em>potentially destructive</em> because the job definitions are a shared resource.</li><li>To update the job definitions on a PR we need to run the <a class="external-link" href="https://ci-beam.apache.org/job/beam_SeedJob/" rel="nofollow">Seed Job</a>. This will cause the job definitions to be read and parsed. Running a seed job is a <strong>high privilege workflow</strong>, so it can only be run by committers.<br/><ul><li><strong>To run a seed job over a committer PR,</strong> one needs only to type &quot;Run Seed Job&quot; into the PR in Github.</li><li><strong>To run a seed job over a non-commiter</strong> <strong>PR,</strong> one needs to follow a hacky workaround: <a class="external-link" href="https://drive.google.com/file/d/1Yk4TIF3Qw_ur4P8fTx1I1469TDFdCHHq/view" rel="nofollow">https://drive.google.com/file/d/1Yk4TIF3Qw_ur4P8fTx1I1469TDFdCHHq/view</a><br/><ul><li>Another option is to have a committer clone the PR and type &quot;Run Seed Job&quot;</li></ul></li></ul></li></ul><h1 id="JenkinsTips-Triggeringjobs">Triggering jobs</h1><p>Beam committers can trigger a job with the Jenkins UI. Non-committers can trigger a job if there is a trigger phrase.</p><ul><li>To trigger a job on Jenkins UI, log in on <a class="external-link" href="https://ci-beam.apache.org/" rel="nofollow">https://ci-beam.apache.org/</a>, find the job page with search, select <strong>Build with Parameters </strong>page from the menu and click Build (you may also specify a build parameter, for example a commit sha1 value).</li><li>Alternatively, to reliably trigger at a specific PR, select <strong>Configure</strong> and add <code>ghprbPullId</code>  as a String parameter. Then set the default for sha1 to <code>origin/pr/${ghprbPullId}/merge</code> . Save.  Then select <strong>Build with Parameters,</strong> and put in the PR number.</li></ul><h1 id="JenkinsTips-Jobsuffixes">Job suffixes</h1><p>Each post-commit and pre-commit job file defines several jobs with different suffixes.</p><ul><li>For pre-commits, there are <code>_Commit</code>, <code>_Phrase</code>, and <code>_Cron</code> suffixes.</li><li>The<code> _Commit</code> job happens with every push to a pull request.</li><li>The <code>_Phrase</code> happens when the trigger phrase is entered as a comment in the pre-commit.</li><li>The <code>_Cron</code> pre-commit happens post-commit on the master branch as a signal of whether the pre-commit would pass without any changes.</li></ul><h1 id="JenkinsTips-Joblabels">Job labels</h1><p>Consider the following tips regarding Jenkins-jobs-related tags:</p><ul><li>Most Beam Jenkins jobs specify the label <code><a class="external-link" href="https://ci-beam.apache.org/label/beam/" rel="nofollow">beam</a></code>, which uses beam executors 1-15.</li><li>Performance test jobs specify the label <code><a class="external-link" href="https://ci-beam.apache.org/label/beam-perf/" rel="nofollow">beam-perf</a></code>, which uses beam executors 16.<ul><li>Used for tests that run locally on the Jenkins worker such as Direct Runner. Configured to run a one job at a time to reduce the noisy neighbor problem</li></ul></li><li>Website publishing job specifies the label <code><a class="external-link" href="https://ci-beam.apache.org/label/git-websites/" rel="nofollow">git-websites</a></code>, which allows publishing generated documentation to the asf-site branch.</li></ul><h1 id="JenkinsTips-Howtoaccessatesthistory">How to access a test history</h1><p>To access a test history:</p><ol><li>Look at this URL:<br/><a class="external-link" href="https://ci-beam.apache.org/job/beam_PreCommit_Java_Phrase/lastCompletedBuild/testReport/junit/org.apache.beam.runners.fnexecution.data/GrpcDataServiceTest/testMessageReceivedBySingleClientWhenThereAreMultipleClients/history/" rel="nofollow">https://ci-beam.apache.org/job/beam_PreCommit_Java_Phrase/lastCompletedBuild/testReport/junit/org.apache.beam.runners.fnexecution.data/GrpcDataServiceTest/testMessageReceivedBySingleCli</a><a class="external-link" href="https://ci-beam.apache.org/job/beam_PreCommit_Java_Phrase/lastCompletedBuild/testReport/junit/org.apache.beam.runners.fnexecution.data/GrpcDataServiceTest/testMessageReceivedBySingleClientWhenThereAreMultipleClients/history/" rel="nofollow" style="letter-spacing: 0.0px;">entWhenThereAreMultipleClients/history/</a></li><li>Go to failed job -&gt; test result -&gt; navigate to failed test -&gt; history</li></ol><p><br/></p><div class="confluence-information-macro confluence-information-macro-information conf-macro output-block" data-hasbody="true" data-macro-name="info"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"> </span><div class="confluence-information-macro-body">Replace relevant fields in URL. There might be issues getting there for succeeded tests. </div></div><h1 id="JenkinsTips-Howtodeletejobsthatarenolongerneeded">How to delete jobs that are no longer needed</h1><p>To delete jobs that are no longer needed in Jenkins: </p><ol><li><p class="auto-cursor-target">Remove the <code>`.groovy`</code> file associated with the job. For more information, see </p><p class="auto-cursor-target"><a class="external-link" href="https://github.com/apache/beam/pull/12891" rel="nofollow">Removes Python 2 and Python 3.5 Postcommit jobs. #12891</a>.</p></li><li>Delete the job history from Jenkins (committers only, if you are not a committer please ask the reviewer of your PR to help with this).<ol><li>Open <a class="external-link" href="https://ci-beam.apache.org/" rel="nofollow">https://ci-beam.apache.org/</a> and log in with your Apache Credentials.</li><li>Select the job you want to remove.</li><li>Click <strong>Delete project</strong> in the left side panel.</li></ol></li></ol><p><br/></p><h1 id="JenkinsTips-JenkinsInfrastructureSetup">Jenkins Infrastructure Setup</h1><p>16 GCE instances support Jenkins' continuous integrating jobs. The instance group <code>'apache-ci-beam-jenkins-nodes'</code> manages the compute instances in the Google Cloud project <code>'apache-beam-testing'</code>. Each instance has 16 CPUs and 104GB of memory. We used to run Jenkins nodes using Apache Jenkins Build cluster (<a class="external-link" href="https://builds.apache.org/" rel="nofollow">https://builds.apache.org/</a>), but we have since migrated to our dedicated cluster: <a class="external-link" href="https://ci-beam.apache.org/" rel="nofollow">https://ci-beam.apache.org/</a>, and there is an old group of workers <code>'apache-beam-jenkins-jnlp'</code> that is now stopped but not yet deleted.</p><div class="table-wrap"><table class="wrapped confluenceTable"><colgroup><col/><col/><col/></colgroup><tbody><tr><th class="confluenceTh">Instance Name</th><th colspan="1" class="confluenceTh">Jenkins agent name</th><th class="confluenceTh">Jenkins Label</th></tr><tr><td class="confluenceTd">apache-ci-beam-jenkins-1</td><td colspan="1" class="confluenceTd">apache-beam-jenkins-1</td><td class="confluenceTd">beam</td></tr><tr><td class="confluenceTd">apache-ci-beam-jenkins-2</td><td colspan="1" class="confluenceTd">apache-beam-jenkins-2</td><td class="confluenceTd">beam</td></tr><tr><td class="confluenceTd">apache-ci-beam-jenkins-3</td><td colspan="1" class="confluenceTd">apache-beam-jenkins-3</td><td class="confluenceTd">beam</td></tr><tr><td class="confluenceTd">apache-ci-beam-jenkins-4</td><td colspan="1" class="confluenceTd">apache-beam-jenkins-4</td><td class="confluenceTd">beam</td></tr><tr><td class="confluenceTd">apache-ci-beam-jenkins-5</td><td colspan="1" class="confluenceTd">apache-beam-jenkins-5</td><td class="confluenceTd">beam</td></tr><tr><td class="confluenceTd">apache-ci-beam-jenkins-6</td><td colspan="1" class="confluenceTd">apache-beam-jenkins-6</td><td class="confluenceTd">beam</td></tr><tr><td class="confluenceTd">apache-ci-beam-jenkins-7</td><td colspan="1" class="confluenceTd">apache-beam-jenkins-7</td><td class="confluenceTd">beam</td></tr><tr><td class="confluenceTd">apache-ci-beam-jenkins-8</td><td colspan="1" class="confluenceTd">apache-beam-jenkins-8</td><td class="confluenceTd">beam</td></tr><tr><td class="confluenceTd">apache-ci-beam-jenkins-9</td><td colspan="1" class="confluenceTd">apache-beam-jenkins-9</td><td class="confluenceTd">beam</td></tr><tr><td class="confluenceTd"><div class="content-wrapper"><p class="auto-cursor-target">apache-ci-beam-jenkins-10</p></div></td><td colspan="1" class="confluenceTd">apache-beam-jenkins-10</td><td class="confluenceTd">beam</td></tr><tr><td class="confluenceTd">apache-ci-beam-jenkins-11</td><td colspan="1" class="confluenceTd">apache-beam-jenkins-11</td><td class="confluenceTd">beam</td></tr><tr><td class="confluenceTd">apache-ci-beam-jenkins-12</td><td colspan="1" class="confluenceTd">apache-beam-jenkins-12</td><td class="confluenceTd">beam</td></tr><tr><td class="confluenceTd">apache-ci-beam-jenkins-13</td><td colspan="1" class="confluenceTd">apache-beam-jenkins-13</td><td class="confluenceTd">beam</td></tr><tr><td class="confluenceTd">apache-ci-beam-jenkins-14</td><td colspan="1" class="confluenceTd">apache-beam-jenkins-14</td><td class="confluenceTd">beam</td></tr><tr><td class="confluenceTd">apache-ci-beam-jenkins-15</td><td colspan="1" class="confluenceTd">apache-beam-jenkins-15</td><td class="confluenceTd">beam</td></tr><tr><td class="confluenceTd">apache-ci-beam-jenkins-16</td><td colspan="1" class="confluenceTd">apache-beam-jenkins-16</td><td class="confluenceTd">beam-perf</td></tr></tbody></table></div><h2 id="JenkinsTips-Currentinstallations">Current installations</h2><ul><li>apache-maven:3.5.4</li><li>Docker:20.10.23</li><li>Go:1.16</li><li>kubectl</li><li>open-jdk-11</li><li>open-jdk-1.8</li><li>Pip:8.1.1</li><li>Python:2.7.12</li><li>Python:3.5.2</li><li>Python:3.6.13</li><li>Python:3.7.10</li><li>Python:3.8.9</li><li>Python:3.9.4</li><li>Python:3.11.2</li><li><p class="auto-cursor-target">Virtualenv:16.4.3</p></li></ul><h2 class="clickable-header" id="JenkinsTips-HowtoinstallandupgradesoftwareonJenkinsworkers">How to install and upgrade software on Jenkins workers</h2><p>All software updates must be performed and verified in a temporary experimental compute instance. To install or upgrade tools for Jenkins instances:</p><ol><li><p>Create a compute instance with the most recently created boot image. </p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">gcloud compute instances create $USER-jenkins-upgrade --project=apache-beam-testing --zone us-central1-b --image-family=jenkins-worker-boot-image --machine-type=n1-highmem-16</pre>
</div></div><div class="confluence-information-macro confluence-information-macro-note conf-macro output-block" data-hasbody="true" data-macro-name="note"><span class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon"> </span><div class="confluence-information-macro-body"><p>You can create the instance through <a class="external-link" href="https://console.cloud.google.com/compute/instances?organizationId=433637338589&amp;project=apache-beam-testing&amp;instancessize=50" rel="nofollow">VM Instances in Cloud Console</a> or by running the<code> gcloud</code> command.</p></div></div></li><li><p>Connect using ssh to the instance via Cloud Console or <code>gcloud</code> command.</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">gcloud compute --project &quot;apache-beam-testing&quot; ssh --zone &quot;us-central1-b&quot; $USER-jenkins-upgrade</pre>
</div></div></li><li><p class="auto-cursor-target">Login as 'jenkins' user.</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">sudo su jenkins</pre>
</div></div></li><li>Install or upgrade the required tools.</li><li><p>Verify the tool by running corresponding Beam tests.</p></li><li><p>Verify backwards compatibility by running Beam PostCommits against all SDKs.</p><ul><li><p>Clone Beam repository from Git:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">git clone https://github.com/apache/beam.git &amp;&amp; cd beam</pre>
</div></div></li><li><p>Run your tests by Gradle wrapper. For example:<span> </span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">./gradlew :PythonPostCommit --continue --&lt;args&gt;</pre>
</div></div></li><li><p>Remove beam repository after verification.</p></li></ul></li><li><p>Create a new image from the your instance and name it as <code>jenkins-worker-boot-image-YYYYMMDD</code>.<span> </span><strong>Put the image in the family of <code>'jenkins-worker-boot-image'</code></strong>, and add a description of your changes.</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">gcloud compute instances stop $USER-jenkins-upgrade --project &quot;apache-beam-testing&quot; --zone &quot;us-central1-b&quot; 

gcloud  compute images create \
  --project apache-beam-testing \
  --source-disk $USER-jenkins-upgrade \
  --source-disk-zone us-central1-b \
  jenkins-worker-boot-image-&lt;YYYYMMDD&gt; \
  --family jenkins-worker-boot-image \
  --description &quot;Updated XYZ, see BEAM-1234.&quot; </pre>
</div></div></li></ol><p>To reboot Jenkins executors with a new image, do the following:</p><ol><li>Go to the page for the Jenkins agent you want to update (<a class="external-link" href="https://ci-beam.apache.org/computer/apache-beam-jenkins-1/" rel="nofollow">for example</a>) and click &quot;Mark this node temporarily offline&quot;, leaving a reason such as &quot;Updating X dependency.&quot; </li><li>Wait until there are no more tests running in that agent (under &quot;Build Executor Status&quot; on the left of the page). You can also prioritize the update on agents currently not running any builds.</li><li>Restart the VM with a new disk:<div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">OLD_IMAGE_DATE=20230217
NEW_IMAGE_DATE=YYYYMMDD
PROJECT=apache-beam-testing
ZONE=us-central1-b

# Select the workers currently offline and not processing any builds,
# that you want to upgrade. 
# For example: for CI_INSTANCE_NUMBER {1..4} {10..12} 16; do 

for CI_INSTANCE_NUMBER in {1..4}; do
  CI_INSTANCE=apache-ci-beam-jenkins-${CI_INSTANCE_NUMBER}
  gcloud compute instances stop $CI_INSTANCE --project $PROJECT --zone $ZONE
  gcloud compute instances detach-disk $CI_INSTANCE --project $PROJECT --zone $ZONE --disk ${CI_INSTANCE}-${OLD_IMAGE_DATE}
  gcloud compute disks create ${CI_INSTANCE}-${NEW_IMAGE_DATE}  --project $PROJECT --zone $ZONE --image=jenkins-worker-boot-image-${NEW_IMAGE_DATE}
  gcloud compute instances   attach-disk $CI_INSTANCE   --project $PROJECT --zone $ZONE  --disk ${CI_INSTANCE}-${NEW_IMAGE_DATE}  --device-name=${CI_INSTANCE}-${NEW_IMAGE_DATE}  --boot
  gcloud compute instances start ${CI_INSTANCE}   --project $PROJECT --zone $ZONE
done  </pre>
</div></div>You could also do these steps via Cloud Console instead of CLI:<ol><li><p>Stop the VM, then click <strong>edit</strong>.</p></li><li><p>Delete the existing boot disk by clicking the '<strong>X</strong>'.</p></li><li><p>Create a new boot disk by using the newly generated image.</p></li><li><p>Name disk as <code>'apache-ci-beam-jenkins-[1,16]-YYYYMMDD'</code>.</p></li><li><p>Make sure the boot disk 'Model' is 'Boot, read/write'.</p></li><li><p class="auto-cursor-target">Start the VM.</p></li></ol></li><li>Mark the node in Jenkins as online again and click &quot;Launch agent&quot; button if there is one.</li><li>Verify that inventory job for this node did not start while the worker was offline, sample build for node #10: <a class="external-link" href="https://ci-beam.apache.org/job/beam_Inventory_apache-beam-jenkins-10/" rel="nofollow">https://ci-beam.apache.org/job/beam_Inventory_apache-beam-jenkins-10</a>. If there is a stuck execution of the inventory job, cancel it manually. TODO (BEAM-13666): we should cancel inventory stuck jobs automatically. </li><li>(Optional) If this is the first agent being updated and you would like to test your changes by running a particular Jenkins job, do the following:<ol><li>Go to the page for the job you want to run (<a class="external-link" href="https://ci-beam.apache.org/job/beam_PostCommit_Go/" rel="nofollow">example</a>).</li><li><span>Click &quot;Configure&quot; on the left menu.</span></li><li>Find the checkmark &quot;Restrict where this project can be run&quot; and change the restriction from &quot;beam&quot; to the specific name of the agent (ex. &quot;apache-beam-jenkins-1&quot;).</li><li>Save and apply that change.</li><li>Back on the page for the job, click &quot;Build with Parameters&quot; on the left menu.</li><li>Run the build on &quot;master&quot;.</li><li>Once you're done checking the results, change the restriction for the job back to &quot;beam&quot;.</li></ol></li><li>Repeat for each worker. You can also do it in batches of workers, but avoid bringing all of the workers offline at once.  </li><li><p class="auto-cursor-target">After confirming that update was successful, we can<span> go to </span><a class="external-link" href="https://console.cloud.google.com/compute/disks?organizationId=433637338589&amp;project=apache-beam-testing" rel="nofollow">Cloud Console Disks</a><span> </span>and clean up deprecated Jenkins worker disks, or do this via cli:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">OLD_IMAGE_DATE=20230217
PROJECT=apache-beam-testing
ZONE=us-central1-b 

for CI_INSTANCE_NUMBER in {1..16}; do
  CI_INSTANCE=apache-ci-beam-jenkins-${CI_INSTANCE_NUMBER}
  gcloud compute disks delete ${CI_INSTANCE}-${OLD_IMAGE_DATE}  --project $PROJECT --zone $ZONE  --quiet 
done</pre>
</div></div></li></ol>