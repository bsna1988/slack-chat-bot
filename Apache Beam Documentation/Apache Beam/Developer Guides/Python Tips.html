<p><div class="toc-macro client-side-toc-macro  conf-macro output-block" data-hasbody="false" data-headerelements="H1,H2" data-macro-name="toc"> </div></p><h1 id="PythonTips-InstallingPythoninterpreters">Installing Python interpreters</h1><p>Apache Beam supports <a class="external-link" href="https://beam.apache.org/get-started/quickstart-py/" rel="nofollow">multiple Python versions</a>. You might be able to iterate on the Beam code using one Python version provided by your OS, assuming this version is also supported by Beam. However you will need to have interpreters for all supported versions to be able to run test suites locally using Gradle, and to work on Beam releases. Therefore, we recommend installing a Python interpreter for each supported version or launching a docker-based development environment that should have these interpreters preinstalled using: <a class="external-link" href="https://github.com/apache/beam/blob/release-2.35.0/start-build-env.sh" rel="nofollow">start-build-env.sh</a> .</p><p>There are several ways how you might install multiple Python versions.</p><ul style="list-style-type: square;"><li>You can download, build and <a class="external-link" href="https://docs.python.org/3/using/unix.html#building-python" rel="nofollow">install CPython from sources</a>.</li><li>If you are an Ubuntu user, you could add a third-party repository '<a class="external-link" href="https://launchpad.net/~deadsnakes/+archive/ubuntu/ppa" rel="nofollow">Deadsnakes</a>' and install the missing versions via apt. If you install from Deadsnakes, make sure to also install <span style="color: rgb(51,51,51);"><code>python#.#-dev</code>, </span><span style="color: rgb(51,51,51);"><code>python#.#-venv</code> and </span><code><span style="color: rgb(51,51,51);">python#</span></code><span style="color: rgb(51,51,51);"><code>.#-distutils </code>packages.</span></li><li>You can use <a class="external-link" href="https://github.com/pyenv/pyenv" rel="nofollow">PyEnv</a> to download and install Python versions (<strong>Recommended</strong>). <br/>Installation steps may look  as follows:<ol><li>Follow the steps below in <a href="#PythonTips-Howtosetuppyenv(withpyenv-virtualenvplugin)">How to setup pyenv</a>.</li><li><p class="auto-cursor-target">Install Python intepreter for each supported Python minor version. For example:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">pyenv install 3.8.9
pyenv install 3.9.4 
pyenv install 3.10.7 
pyenv install 3.11.3</pre>
</div></div><p class="auto-cursor-target">For major.minor.patch versions currently used by Jenkins cluster, see  <a href="/confluence/display/BEAM/Jenkins+Tips#JenkinsTips-Currentinstallations">Current Installations</a>.</p></li><li><p class="auto-cursor-target">Make installed interpreters available in your shell by running</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">pyenv global 3.8.9 3.9.4 3.10.7 3.11.3</pre>
</div></div></li><li><p class="auto-cursor-target">(OPTIONAL) Pyenv will sometimes <a class="external-link" href="https://github.com/pyenv/pyenv/issues/34" rel="nofollow">fail to make these interpreters directly available</a> without a local configuration. If you see errors trying to use <code>python3.x</code> , then run also <code>pyenv local</code>  </p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">pyenv local 3.8.9 3.9.4 3.10.7 3.11.3</pre>
</div></div></li></ol></li></ul><p style="margin-left: 40.0px;">After these steps, all <code>python3.x</code>  interpreters should be available in your shell. The first version in the list passed to <code>pyenv global</code> will be used as default <code>python / python3</code> interpreter if the minor version is not specified.</p><p style="margin-left: 40.0px;">Please contribute to these instructions if they didn't work for you.</p><h1 id="PythonTips-DevelopingthePythonSDK">Developing the Python SDK</h1><ul><li>Beam Gradle tooling can build and test Python SDK, and Jenkins jobs use it, so it needs to be maintained.</li><li>You can directly use the Python toolchain instead of having Gradle orchestrate it, which may be faster for you, but it is your preference. If you want to use Python tools directly, we recommend setting up a virtual environment before testing your code.</li><li>The commands below assume that you're in the <code class="highlighter-rouge">SDKs/python</code> directory.</li></ul><h1 id="PythonTips-VirtualEnvironmentSetup">Virtual Environment Setup</h1><p>Setting up a virtual environment is required for running tests directly, such as via <code>pytest</code> or an IDE like PyCharm. To create an environment, installs Python SDK from the sources with  test and GCP dependencies, follow the below instructions:</p><h3 id="PythonTips-OnmacOS/Linux">On macOS/Linux</h3><ol><li><p class="auto-cursor-target">Use the following code:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default"># Initialize virtual environment called &quot;env&quot; in ~/.virtualenvs or any other directory. (Consider using pyenv, to manage the python version as well as installed packages in your virtual environment)
$ python3 -m venv ~/.virtualenvs/env

# Activate virtual environment.
$ . ~/.virtualenvs/env/bin/activate

# Upgrade other tools. (Optional)
pip install --upgrade pip
pip install --upgrade setuptools

# Install Apache Beam package in editable mode.
(env) $ pip install -e .[gcp,test]

</pre>
</div></div><p class="auto-cursor-target">For certain systems, particularly Macs with M1 chips, this installation method may not generate urns correctly. If running <code>python gen_protos.py</code>  doesn't resolve the issue, consult <a class="external-link" href="https://github.com/apache/beam/issues/22742#issuecomment-1218216468" rel="nofollow">https://github.com/apache/beam/issues/22742#issuecomment-1218216468</a> for further guidance.</p></li></ol><h3 id="PythonTips-OnWindows">On Windows</h3><ol><li><p class="auto-cursor-target">Use the following code:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">&gt; c:\Python37\python.exe -m venv c:\path\to\env
&gt; c:\path\to\env\Scripts\activate.bat 
# Powershell users should run instead: 
&gt; c:\path\to\env\Scripts\activate.ps1 

(env) &gt; pip install -e .[gcp,test]</pre>
</div></div></li><li><p class="auto-cursor-target">You can deactivate the <code>virtualenv</code> when done.</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">(env) $ deactivate</pre>
</div></div></li></ol><h1 class="auto-cursor-target" id="PythonTips-VirtualEnvironmentswithpyenv">Virtual Environments with <code>pyenv</code></h1><ul><li class="auto-cursor-target">A more advanced option, <code>pyenv</code> allows you to download, build, and install locally any version of Python, regardless of which versions your distribution supports.</li><li class="auto-cursor-target"><code>pyenv</code> also has a <code>virtualenv</code> plugin, which manages the creation and activation of <code>virtualenvs</code>.</li><li class="auto-cursor-target">The caveat is that you'll have to take care of any build dependencies, and those are probably still constrained by your distribution.</li><li class="auto-cursor-target">These instructions were made on a Linux/Debian system.</li></ul><p><br/></p><h2 class="auto-cursor-target" id="PythonTips-Howtosetuppyenv(withpyenv-virtualenvplugin)">How to setup <code>pyenv </code>(with <a class="external-link" href="https://github.com/pyenv/pyenv-virtualenv" rel="nofollow">pyenv-virtualenv</a> plugin)</h2><ol><li><p class="auto-cursor-target"><span>Install </span><a class="external-link" href="https://github.com/pyenv/pyenv/wiki#suggested-build-environment" rel="nofollow"><span>prerequisites</span></a><span> for your distribution.</span></p></li><li><span>curl <code><span class="nolink">https://pyenv.run</span> | bash</code></span></li><li><span>Add the required lines to <code>~/.bashrc</code> (as returned by the script). </span></li><li><span>Note (12/10/2021): You may have to manually modify .bashrc as described here: <a class="external-link" href="https://github.com/pyenv/pyenv-installer/issues/112#issuecomment-971964711" rel="nofollow">https://github.com/pyenv/pyenv-installer/issues/112#issuecomment-971964711</a>. Remove this note if no longer applicable.</span></li><li>Open a new shell. If <code>pyenv</code> command is still not available in PATH, you may need to restart the login session. </li></ol><p><br/></p><p><strong>Example on Ubuntu:</strong></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default"># Install pyenv deps
sudo apt-get install -y build-essential libssl-dev zlib1g-dev libbz2-dev \
libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev libncursesw5-dev \
xz-utils tk-dev libffi-dev liblzma-dev python3-openssl git

# Install pyenv, and pyenv-virtualenv plugin
curl https://pyenv.run | bash

# Run the outputted commands to initialize pyenv in .bashrc</pre>
</div></div><h3 id="PythonTips-Example:HowtoRunUnitTestswithPyCharmUsingPython3.8.9inavirtualenv">Example: How to Run Unit Tests with PyCharm Using Python 3.8.9 in a <code>virtualenv</code></h3><ol><li>Install Python 3.8.9 and create a <code>virtualenv</code><ul><li><code>pyenv</code> install 3.8.9</li><li><code>pyenv</code> <code>virtualenv</code> 3.8.9 <code>ENV_NAME</code></li><li><code>pyenv</code> <span>activate</span> <code>ENV_NAME</code></li></ul></li><li><p class="auto-cursor-target">Upgrade packages (recommended)</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Default" data-theme="Default">pip install --upgrade pip setuptools</pre>
</div></div></li><li>Set up PyCharm<ol><li><span>Start by adding a new project interpreter (from the bottom right or in <strong>Settings</strong>).</span></li><li><span>Select <strong>Existing environment</strong> and the interpreter, which should be under <code>~/.pyenv/versions/3.8.9/envs/ENV_NAME/bin/python</code> or <code>~/.pyenv/versions/ENV_NAME/bin/python</code>.</span></li><li><span>Switch interpreters at the bottom right.</span></li></ol></li></ol><h3 id="PythonTips-Cleaningupenvironments">Cleaning up environments</h3><p>To delete all environments created with pyenv, run:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Default" data-theme="Default">pyenv virtualenvs --bare --skip-aliases | xargs -n 1 pyenv virtualenv-delete -f</pre>
</div></div><h3 class="auto-cursor-target" id="PythonTips-Troubleshooting"><strong>Troubleshooting</strong></h3><p><span>If you have issues, find troubleshooting at <a class="external-link" href="https://github.com/pyenv/pyenv/wiki/Common-build-problems" rel="nofollow"><code>pyenv</code> common build problems</a>.</span></p><p><br/></p><div class="confluence-information-macro confluence-information-macro-note conf-macro output-block" data-hasbody="true" data-macro-name="note"><p class="title conf-macro-render">Error: No module named distutils. (23/07/2021)</p><span class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon"> </span><div class="confluence-information-macro-body"><p>As of 23/07/2021, users of some versions of Debian are currently experiencing the error &quot;<span style="color: rgb(32,33,36);">ModuleNotFoundError: No module named 'distutils.util'&quot; when using the Python Beam SDK.</span><span style="color: rgb(32,33,36);"> This is typically because a desired version of Python interpreter is no longer available in the distribution. This can be fixed by installing Python via pyenv, rather than relying on the packages included with the Debian distribution.  See <a href="#PythonTips-InstallingPythoninterpreters">Installing Python interpreters</a> above. <br /><br />The error may also manifest in environments created with <code>virtualenv</code>  tool even with Python interpreters installed via pyenv. The workaround can be to downgrade to <code>virtualenv==16.1 </code>or use pyenv or venv to create virtual environments. You will also likely need to clean the previously created environment: <code>rm -rf /path/to/beam/build/gradlenv</code><br /></span></p></div></div><h1 class="auto-cursor-target" id="PythonTips-RunningTests">Running Tests</h1><p>If you update any of the <em><a class="external-link" href="http://cython.org/" rel="nofollow">cythonized</a> </em>files in Python SDK, you must first install the <code class="highlighter-rouge">cython</code> package, and run the following command before testing your changes</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Default" data-theme="Default">python setup.py build_ext --inplace</pre>
</div></div><h2 class="auto-cursor-target" id="PythonTips-RunningTestsUsingpytest">Running Tests Using <code>pytest</code></h2><p>If you've set up a <code>virtualenv</code> above, you can now run tests directly using <code>pytest</code>.</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">(env) $ pytest  # all tests

# You can also select specific tests. Try out these examples.
(env) $ pytest -v -k test_progress
(env) $ pytest -v -k TextSourceTest
(env) $ pytest -v apache_beam/io/textio_test.py::TextSourceTest::test_progress
(env) $ pytest -v apache_beam/io/textio_test.py</pre>
</div></div><h2 id="PythonTips-RunningIntegrationTestsUsingpytest">Running Integration Tests Using <code>pytest</code></h2><p>To run an integration test you may need to specify additional parameters for the runner.</p><p>Unless you are using Direct runner,  you must build the Beam SDK tarball. To do so, run the following commands from the root of the git repository.</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">cd sdks/python/
pip install build &amp;&amp; python -m build --sdist</pre>
</div></div><p>We will use the tarball built by this command in the <code>--sdk_location</code> parameter.</p><p>It is helpful to emit the test logs to console immediately when they occur. You can do so with the  <code>-o log_cli=True</code> option. You could additionally customize the logging level with the <code>log_level</code> option.</p><p>Sample invocation:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Running integration test</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">python -m pytest  -o log_cli=True -o log_level=Info apache_beam/ml/gcp/cloud_dlp_it_test.py::CloudDLPIT::test_inspection  --test-pipeline-options='--runner=TestDataflowRunner --project=&lt;project&gt; --temp_location=gs://&lt;bucket&gt;/tmp --sdk_location=dist/apache-beam-2.35.0.dev0.tar.gz --region=us-central1' --timeout=36000</pre>
</div></div><h3 id="PythonTips-TimeoutsinIntegrationTests">Timeouts in Integration Tests</h3><p>While integration tests running on Jenkins have timeouts that are set with an adequate buffer (<a class="external-link" href="https://github.com/apache/beam/blob/master/sdks/python/test-suites/dataflow/common.gradle#L34" rel="nofollow">4500 secs</a>), tests that are invoked locally via <code>python -m pytest ...</code> may encounter timeout failures. This is because the <code>timeout</code> property defined in our <code><a class="external-link" href="https://github.com/apache/beam/blob/master/sdks/python/pytest.ini#L48" rel="nofollow">pytest.ini</a></code> file is set to 600 secs, which may not be enough time for a particular integration test. To get around this, either change the value of <code>timeout</code>  to a higher number, or add a <code>pytest</code> timeout decorator<span> above the function(s) inside your <code>pytest</code> class.</span></p><p><span>Example:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Default" data-theme="Default">class PubSubIntegrationTest(unittest.TestCase):

  @pytest.mark.timeout(1200)
  def test_streaming_with_attributes(self):
	# test logic here</pre>
</div></div><p><span>For more information about timeouts in <code>pytest</code>, go to this <a class="external-link" href="https://pypi.org/project/pytest-timeout/" rel="nofollow">site</a>.</span></p><h2 id="PythonTips-RunningUnitTestsUsingtox">Running Unit Tests Using tox</h2><p>Here are some tips for running tests using tox:</p><ul><li>Tox does not require a <code>virtualenv</code> with Beam + dependencies installed. It creates its own.</li><li>It also runs tests faster, utilizing multiple processes (via <code>pytest-xdist</code>).</li><li>For a list of environments, run <code>tox -l</code>.</li><li>tox also supports passing arguments after double dashes to <code>pytest</code>.</li></ul><p>Execute the following code for running tests using tox:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">(env) $ pip install tox
(env) $ tox -c tox.ini tox run -e py38-cloud  # all tests
(env) $ tox -c tox.ini run -e py38 -- -k test_progress</pre>
</div></div><h2 id="PythonTips-RunningTestsUsinggradle">Running Tests Using gradle</h2><p><span style="color: rgb(32,33,36);">Integration tests suites on Jenkins are configured in groovy files that launch certain gradle tasks (<a class="external-link" href="https://github.com/apache/beam/blob/0fd6a044df5b9f26d567e0f9a619a665a0f4043b/.test-infra/jenkins/job_PostCommit_Python.groovy#L43" rel="nofollow">example</a>). You could launch test suites locally by executing the gradle targets directly (for example: <span class="U8d2H" style="color: rgb(32,33,36);">.<code>/gradlew :sdks:python:test-suites:dataflow:py37:postCommitPy37</code></span>). This option may only be available to committers, as by default  the test suites are configured to use <code><span style="color: rgb(0,51,102);"><a class="external-link" href="https://github.com/apache/beam/blob/0fd6a044df5b9f26d567e0f9a619a665a0f4043b/sdks/python/scripts/run_integration_test.sh#L70" rel="nofollow">apache-beam-testing</a></span></code> project.</span></p><p><span style="color: rgb(32,33,36);">To run only a subset of tests using this approach, you could adjust the test label in the test (such as </span><a class="external-link" href="https://github.com/apache/beam/blob/25e6008e8919c2f31eaebae2662b44e02f9f37a1/sdks/python/apache_beam/io/gcp/pubsub_integration_test.py#L211" rel="nofollow" style="text-decoration: none;">it_postcommit</a>)<span style="color: rgb(32,33,36);"> and the </span><a class="external-link" href="https://github.com/apache/beam/blob/25e6008e8919c2f31eaebae2662b44e02f9f37a1/sdks/python/test-suites/dataflow/common.gradle#L117" rel="nofollow" style="text-decoration: none;">selector</a><span style="color: rgb(32,33,36);"> where the test suite is defined.</span></p><h1 id="PythonTips-LintandFormattingChecks">Lint and Formatting Checks</h1><p>Beam codebase enforces consistency of the code style and formatting rules using <code>linters</code> and an autoformatting tool <code><a class="external-link" href="https://github.com/google/yapf" rel="nofollow">y</a></code><code style="letter-spacing: 0.0px;"><a class="external-link" href="https://github.com/google/yapf" rel="nofollow">apf</a></code><span style="letter-spacing: 0.0px;">.</span></p><p><br/></p><ul><li><p class="auto-cursor-target">To run all consistency checks, run the following commands:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">pip install tox
../../gradlew lint       # Runs several linter checks
tox -e py3-yapf-check    # Runs code formatting checks</pre>
</div></div></li><li class="auto-cursor-target"><p class="auto-cursor-target"><span style="letter-spacing: 0.0px;">To auto-format the code in place, run:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">tox -e py3-yapf</pre>
</div></div></li></ul><p><br/></p><h2 id="PythonTips-RunninglintandyapfAutomaticallyonEachCommitwithpre-commitHooks">Running lint and <code>yapf</code> Automatically on Each Commit with pre-commit Hooks</h2><p>The <a class="external-link" href="https://github.com/pre-commit/" rel="nofollow">pre-commit</a> tool allows you to run <a class="external-link" href="https://github.com/apache/beam/blob/master/.pre-commit-config.yaml" rel="nofollow">pre-configured</a> checks automatically when you commit changes with `<code>git commit</code>`.</p><ul><li><p class="auto-cursor-target">To enable <strong>pre-commit,</strong> run: </p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">pip install pre-commit
pre-commit install</pre>
</div></div><div class="confluence-information-macro confluence-information-macro-note conf-macro output-block" data-hasbody="true" data-macro-name="note"><span class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon"> </span><div class="confluence-information-macro-body"><p>When the <strong>pre-commit </strong>hook for <code><strong>yapf</strong></code>  applies formatting changes in place, the check  fails with an error  <code>files were modified by this hook</code>, and you have to re-run `<code>git commit</code>`.</p></div></div></li><li><p class="auto-cursor-target">To disable the <strong>pre-commit,</strong> run: </p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">pre-commit uninstall</pre>
</div></div></li></ul><h2 id="PythonTips-Runningyapfformattermanually">Running yapf formatter manually</h2><p class="auto-cursor-target">To run manually:</p><ol><li><p class="auto-cursor-target">Install <code><a class="external-link" href="https://github.com/google/yapf" rel="nofollow">yapf</a></code>.  </p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">pip install yapf==0.29.0</pre>
</div></div><div class="confluence-information-macro confluence-information-macro-note conf-macro output-block" data-hasbody="true" data-macro-name="note"><span class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon"> </span><div class="confluence-information-macro-body"><p class="auto-cursor-target">For consistency, use the current version of <code>yapf</code> in <a class="external-link" href="https://github.com/apache/beam/search?q=%22yapf%3D%3D%22+filename%3Atox.ini" rel="nofollow">https://github.com/apache/beam/blob/master/sdks/python/tox.ini</a></p></div></div></li><li class="auto-cursor-target"><p class="auto-cursor-target">To format changed files in your branch:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default"># Run from root beam repo dir
git diff master --name-only | grep &quot;\.py$&quot; | xargs yapf --in-place</pre>
</div></div></li><li class="auto-cursor-target"><p class="auto-cursor-target"><span style="letter-spacing: 0.0px;">To format just a single directory:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">yapf --in-place --parallel --recursive apache_beam/path/to/files</pre>
</div></div></li><li class="auto-cursor-target"><p class="auto-cursor-target">To format files with uncommitted changes, run: </p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">git diff --name-only | grep &quot;\.py$&quot; | xargs yapf --in-place</pre>
</div></div></li><li class="auto-cursor-target">If you need to exclude one particular file or pattern from formatting, add it to the <code>.yapfignore</code> file (<code>sdks/python/.yapfignore</code>).</li></ol><h1 class="auto-cursor-target" id="PythonTips-RunhelloworldagainstmodifiedSDKHarness">Run hello world against modified SDK Harness</h1><p class="auto-cursor-target">To run a <code>hello world</code> against modified SDK Harness, execute the following code:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default"># Build the Flink job server (default job server for PortableRunner) that stores the container locally.
./gradlew :runners:flink:1.7:job-server:container:docker


# Build portable SDK Harness, which builds and stores the container locally.
# Build for all python versions
./gradlew :sdks:python:container:buildAll
# Or build for a specific python version, such as py35
./gradlew :sdks:python:container:py35:docker


# Run the pipeline.
python -m apache_beam.examples.wordcount --runner PortableRunner --input &lt;local input file&gt; --output &lt;local output file&gt;</pre>
</div></div><p><br/></p><h1 id="PythonTips-RunhelloworldagainstmodifiedDataflowFnAPIRunnerHarnessandSDKHarness">Run hello world against modified Dataflow Fn API Runner Harness and SDK Harness</h1><p>To run a <code>hello world</code> against modified Dataflow Fn API Runner Harness and SDK Harness, execute the following code:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default"># Build portable worker
./gradlew :runners:google-cloud-dataflow-java:worker:build -x spotlessJava -x rat -x test
./gradlew :runners:google-cloud-dataflow-java:worker:shadowJar

# Build portable Pyhon SDK harness and publish it to GCP
./gradlew -Pdocker-repository-root=gcr.io/dataflow-build/$USER/beam -p sdks/python/container docker
gcloud docker -- push gcr.io/dataflow-build/$USER/beam/python:latest

# Initialize python
cd sdks/python
virtualenv env
. ./env/bin/activate

# run pipeline
python -m apache_beam.examples.wordcount   --runner DataflowRunner   --num_workers 1   --project &lt;gcp_project_name&gt;   --output &lt;gs://path&gt;   --temp_location &lt;gs://path&gt;   --sdk_container_image gcr.io/dataflow-build/$USER/beam/python:latest   --experiment beam_fn_api   --sdk_location build/apache-beam-2.12.0.dev0.tar.gz  --debug
</pre>
</div></div><p><br/></p><h1 id="PythonTips-RunIntegrationTestfromIDE(TODO:pleaserevisetheseinstructionsnowthatwemigratedtoPyTest)">Run Integration Test from IDE (TODO: please revise these instructions now that we migrated to PyTest)</h1><p>To run an integration test from an IDE in a debug mode, you can create a Nosetests configuration. For example, to run a VR test on Dataflow runner from IntelliJ/PyCharm, you can adjust the configuration as follows:</p><ol><li>Set <strong>Target </strong>to <code>Module</code> and point to the <code>test</code> file. </li><li><p class="auto-cursor-target">Set <strong>Additional arguments </strong>(sample, adjust as needed)<strong>:  </strong></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Running a ValidatesRunner test</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">--test-pipeline-options=&quot;--runner=TestDataflowRunner --project=&lt;YOUR PROJECT&gt; --region=us-central1 --temp_location=gs://your_bucket/tmp --sdk_location=./dist/apache-beam-&lt;version&gt;.dev0.tar.gz  --requirements_file=./postcommit_requirements.txt --num_workers=1 --sleep_secs=20&quot; --attr=ValidatesRunner1 --nocapture</pre>
</div></div></li><li>Set <strong>Working directory </strong>to <code>/path/to/beam/sdks/python</code>. </li></ol><h1 id="PythonTips-RunascreendiffintegrationTestforInteractiveBeam">Run a <code>screen diff integration</code> Test for Interactive Beam</h1><p>For Interactive Beam/Notebooks, we need to verify if the visual presentation of executing a notebook is stable. A <code><span style="color: rgb(0,51,102);">screen diff integration</span></code> test that executes a test notebook and compares results with a golden screenshot does the trick. To run a <code>screen diff integration </code>Test for Interactive Beam:</p><ol><li><p class="auto-cursor-target"><span style="letter-spacing: 0.0px;">Execute the following code for preparation work:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Test dependencies</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default"># Install additional Python dependencies if absent, under beam/sdks/python, run:
pip install -e .[interactive,interactive_test,test]

# The tests use headless chrome to render visual elements, make sure the machine has chrome executable installed.
# If you're reading this document in a chrome browser, you're good to go for this step.
# Otherwise, e.g., on a Linux machine, you might want to do:
wget --quiet https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb &amp;&amp; \
    apt install -y ./google-chrome-stable_current_amd64.deb

# As chrome version advances/differs, the chromedriver-binary needs to stay in sync with chrome.
# Below is a bash example to dynamically install the correct chromedriver-binary.
google_chrome_version=$(google-chrome --product-version)
chromedriver_lower_version=${google_chrome_version%.*.*.*}
chromedriver_upper_version=$(($chromedriver_lower_version+1))
pip install &quot;chromedriver-binary&gt;=${chromedriver_lower_version},&lt;${chromedriver_upper_version}&quot;

# For consistency of screenshots, roboto-mono font should have been installed.
# You can download the font from https://fonts.google.com/specimen/Roboto+Mono.
# Otherwise, you can install through CLI, e.g., on Linux:
wget --content-disposition -P /usr/share/fonts/truetype/robotomono \
    https://github.com/google/fonts/blob/master/apache/robotomono/static/RobotoMono-{Bold,BoldItalic,Italic,Light,LightItalic,Medium,MediumItalic,Regular,Thin,ThinItalic}.ttf?raw=true</pre>
</div></div></li><li><p class="auto-cursor-target"><span style="letter-spacing: 0.0px;">To run the tests:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>Running screen diff integration test</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default"># Under beam/sdks/python, run:
pytest -v apache_beam/runners/interactive/testing/integration/tests


# TL;DR: you can use other test modules, such as nosetests and unittest:
nosetests apache_beam/runners/interactive/testing/integration/tests
python -m unittest apache_beam/runners/interactive/testing/integration/tests/init_square_cube_test.py
# To generate new golden screenshots for screen diff comparison:
nosetests apache_beam/runners/interactive/testing/integration/tests --with-save-baseline</pre>
</div></div></li><li><p class="auto-cursor-target"><span style="letter-spacing: 0.0px;">Golden screenshots are temporarily taken and stored by the system platform. The currently supported platforms are Darwin (macOS) and Linux.</span></p></li><li><p class="auto-cursor-target"><span style="letter-spacing: 0.0px;">Each test will generate a stable unique hexadecimal id. The golden screenshots are named after that id.</span></p></li><li><p class="auto-cursor-target"><span style="letter-spacing: 0.0px;">To add new tests, put a new test <code>notebook</code> file (<code>.ipynb</code>) under the <code>apache_beam/runners/interactive/testing/integration/test_notebooks</code> directory. </span></p></li><li><p class="auto-cursor-target"><span style="letter-spacing: 0.0px;">Add a single test under <code>apache_beam/runners/interactive/testing/integration/tests</code> directory. </span><span style="letter-spacing: 0.0px;">A test is simple as:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>SimpleTest</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: py; gutter: false; theme: Default" data-theme="Default">from apache_beam.runners.interactive.testing.integration.screen_diff import BaseTestCase

class SimpleTest(BaseTestCase):
  def test_simple_notebook(self):
    self.assert_notebook('simple_notebook')  # Just put the notebook file name here, e.g., 'simple_notebook'.</pre>
</div></div></li></ol><h1 id="PythonTips-HowtoInstallanUnreleasedPythonSDKwithoutBuildingIt">How to Install an Unreleased Python SDK without Building It </h1><p><span>SDK source zip archive and wheels are continuously built after merged commits to <span style="color: rgb(0,0,0);"><a class="external-link" href="https://github.com/apache/beam" rel="nofollow">https://github.com/apache/beam</a></span></span></p><ol><li><span>Click on a recent `Build python source distribution and wheels job` that ran successfully on the </span><a class="external-link" href="https://github.com/apache/beam" rel="nofollow"><span>github.com/apache/beam</span></a><span> master branch from </span><a class="external-link" href="https://github.com/apache/beam/actions?query=workflow%3A%22Build+python+source+distribution+and+wheels%22+branch%3Amaster+is%3Asuccess" rel="nofollow"><span>this list</span></a><span>. </span></li><li><span>Click on <strong>List files on Google Cloud Storage Bucket</strong> on the right-side panel.</span></li><li><span>Expand <strong>List file on Google Cloud Storage Bucket</strong> in the main panel.</span></li><li><span>Locate and Download the ZIP file. For example, <code>apache-beam-2.52.0.dev0.tar.gz</code> from GCS.</span></li><ul><li><span>It’s simplest to download the file using your browser by replacing the prefix “gs://” with “</span><a class="external-link" href="https://storage.googleapis.com/" rel="nofollow"><span>https://storage.googleapis.com/</span></a><span>” . For example,  </span><a class="external-link" href="https://storage.googleapis.com/beam-wheels-staging/master/02bf081d0e86f16395af415cebee2812620aff4b-207975627/apache-beam-2.25.0.dev0.zip" rel="nofollow"><span>https://storage.googleapis.com/beam-wheels-staging/master/02bf081d0e86f16395af415cebee2812620aff4b-207975627/apache-beam-2.25.0.dev0.zip</span></a></li><li><span>Or follow these instructions to download </span><a class="external-link" href="https://cloud.google.com/storage/docs/downloading-objects" rel="nofollow"><span>using the <code>gsutil</code> command-line tool</span></a><span>. </span></li></ul><li><p class="auto-cursor-target"><span>Install the downloaded zip file. For example:<br/></span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>SimpleTest</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">pip install apache-beam-2.52.0.dev0.tar.gz
# Or, if you need extra dependencies:
pip install apache-beam-2.52.0.dev0.tar.gz[aws,gcp]</pre>
</div></div></li><li><span>When you run your Beam pipeline, pass in the <code>--sdk_location</code> flag pointed at the same ZIP file. </span><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"><b>SimpleTest</b></div><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: bash; gutter: false; theme: Default" data-theme="Default">--sdk_location=apache-beam-2.52.0.dev0.tar.gz</pre>
</div></div></li></ol><h1 id="PythonTips-HowtoupdatedependenciesthatareinstalledinPythoncontainerimages">How to update dependencies that are installed in Python container images </h1><p>When we build  Python <a class="external-link" href="https://beam.apache.org/documentation/runtime/environments/" rel="nofollow">container images for Apache Beam SDK</a>, we install PyPI packages of Apache Beam and some additional PyPi dependencies that will likely benefit users. The complete list of  dependencies is specified in <a class="external-link" href="https://github.com/apache/beam/blob/release-2.35.0/sdks/python/container/py37/base_image_requirements.txt" rel="nofollow">base_image_requirements.txt</a> files, for each Python minor version. These files are generated from Beam SDK <a class="external-link" href="https://github.com/apache/beam/blob/release-2.35.0/sdks/python/setup.py#L126" rel="nofollow">requirements, specified in setup.py</a>, and a short list of additional dependencies specified in <a class="external-link" href="https://github.com/apache/beam/blob/release-2.35.0/sdks/python/container/base_image_requirements_manual.txt" rel="nofollow">base_image_requirements_manual.txt</a>.</p><p>We<a class="external-link" href="https://github.com/apache/beam/blob/release-2.35.0/sdks/python/container/Dockerfile#L41-L42" rel="nofollow"> expect </a>all Beam dependencies (including transitive dependencies, and deps for some of the 'extra's, like [gcp]) to be specified with exact versions in the requirements files. When you   modify Python SDKs dependencies in setup.py, you might need to regenerate the requirements files when or wait until a <a class="external-link" href="https://github.com/apache/beam/pulls?q=is%3Apr+author%3Aapp%2Fgithub-actions" rel="nofollow">PR updating Python dependency files</a> is merged.</p><p>Regenerate the requirements files by running:<span> </span><code>./gradlew :sdks:python:container:generatePythonRequirementsAll</code><span> </span>and commiting the changes. Execution can take up to 5 min per Python version and is somewhat resource-demanding. You can also regenerate the dependencies individually per version with targets like<span> </span><code>./gradlew :sdks:python:container:py38:generatePythonRequirements</code>.</p><p><br/></p><p><code> </code></p><p>To run the command successfully, you will need  Python interpreters for all versions supported by Beam. See: <a href="#PythonTips-InstallingPythoninterpreters">Installing Python Interpreters</a>.<br/><br/>Updating dependencies can potentially break Beam. Core dependencies should preferably be updated only after a <a class="external-link" href="https://calendar.google.com/calendar/u/0/embed?src=0p73sl034k80oob7seouanigd0@group.calendar.google.com&amp;ctz=America/Los_Angeles" rel="nofollow">release branch is cut</a>, but not immediately before a release branch is cut. This will allow for a longer timeframe to exercise new dependencies in tests. </p><p><strong>NOTE for RELEASE</strong> <strong>MANAGERS</strong>: We should update dependencies at least once per release . Verify that a <a class="external-link" href="https://github.com/apache/beam/pulls?q=is%3Apr+author%3Aapp%2Fgithub-actions" rel="nofollow">PR updating Python dependency files</a> have been merged into Beam's <code>master</code> . Any PRs that are open too close to release cut date should preferably merged into master after release branch is cut. In some cases, we should prioritize dependency upgrade to pick up fixes for security vulnerabilities.  </p><h2 id="PythonTips-Errors">Errors </h2><p>You may see that the pip command will lead to segmentation fault as well. If this happens, remove the python version from pyenv, and reinstall the version like this.</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Default" data-theme="Default">CFLAGS=&quot;-O2&quot; pyenv install 3.8.9</pre>
</div></div><p>There have been issues with older Python versions. See <a class="external-link" href="https://github.com/pyenv/pyenv/issues/2046" rel="nofollow">here</a> for details.</p>