<p>The Apache Beam project tracks a set of community and project health metrics, with targets to ensure a healthy, sustainable community (ex: test timing and reliability, pull request latency). The dashboards are available at: <a class="external-link" href="https://s.apache.org/beam-community-metrics" rel="nofollow">https://s.apache.org/beam-community-metrics</a>.</p><p><span><span style="color: rgb(0,0,0);"><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-external-resource" draggable="false" height="355" width="560" src="https://lh5.googleusercontent.com/JE2kWQzPjsCY0BC2RQzyLeyZuJCdBn1ui_MaWSYAlyWj_m2kB4Hivnj0Pugh8QSS8Rn8AA4d2nhsqPkWJ426DZWHSEcgvmRzjDnjvy0wcTGg8_i0MJpvLYVx8Xqh1to6Z4p7_wQI" data-image-src="https://lh5.googleusercontent.com/JE2kWQzPjsCY0BC2RQzyLeyZuJCdBn1ui_MaWSYAlyWj_m2kB4Hivnj0Pugh8QSS8Rn8AA4d2nhsqPkWJ426DZWHSEcgvmRzjDnjvy0wcTGg8_i0MJpvLYVx8Xqh1to6Z4p7_wQI"></span></span></span></p><p><div class="toc-macro client-side-toc-macro  conf-macro output-block" data-hasbody="false" data-headerelements="H1,H2,H3,H4,H5,H6,H7" data-macro-name="toc"> </div></p><h1 id="CommunityMetrics-Resources">Resources</h1><ul><li><a class="external-link" href="https://s.apache.org/beam-community-metrics" rel="nofollow">s.apache.org/beam-community-metrics</a></li><li>Design docs:<br/><ul><li style="list-style-type: disc;"><p><span style="color: rgb(17,85,204);"><a class="external-link" href="https://docs.google.com/document/d/1udtvggmS2LTMmdwjEtZCcUQy6aQAiYTI3OrTP8CLfJM" rel="nofollow">Beam Fast Precommits</a></span></p></li><li style="list-style-type: disc;"><p><span><a class="external-link" href="https://docs.google.com/document/d/1sczGwnCvdHiboVajGVdnZL0rfnr7ViXXAebBAf_uQME" rel="nofollow"><span style="color: rgb(17,85,204);">Increase Beam post-commit tests stability</span></a><span style="color: rgb(0,0,0);"> </span></span></p></li><li style="list-style-type: disc;"><p><a class="external-link" href="https://s.apache.org/beam-code-review" rel="nofollow"><span> </span><span style="color: rgb(17,85,204);">Improving Beam Code Review</span></a></p></li><li style="list-style-type: disc;"><p><a class="external-link" href="https://s.apache.org/beam-community-metrics-infra" rel="nofollow">Beam Community Metrics Infrastructure</a></p></li></ul></li><li>Source code: <a class="external-link" href="https://github.com/apache/beam/tree/master/.test-infra/metrics" rel="nofollow">.test-infra/metrics</a></li><li>Feature Requests: JIRA label <a class="external-link" href="https://issues.apache.org/jira/issues/?jql=project%20%3D%20BEAM%20AND%20labels%20%3D%20community-metrics" rel="nofollow">community-metrics</a></li><li>Monitoring: Jenkins <a class="external-link" href="https://ci-beam.apache.org/job/beam_Prober_CommunityMetrics/" rel="nofollow">beam_Prober_CommunityMetrics</a></li></ul><h1 id="CommunityMetrics-UpdatingandDeploying">Updating and Deploying</h1><p>Instructions for developing and making updates to the metrics pipelines and dashboards are checked-in: <a class="external-link" href="https://github.com/apache/beam/blob/master/.test-infra/metrics/README.md" rel="nofollow">README.md</a>.</p><p>Local development and deployment is managed by docker-compose, while the production environment is deployed via Kubernetes and Cloud SQL on Google Cloud.</p><h2 id="CommunityMetrics-AnalyticsDatabase">Analytics Database</h2><p>Metric data is imported to and queried from a Postgresql analytics database. Our database is deployed on <a class="external-link" href="https://cloud.google.com/sql" rel="nofollow">Google Cloud SQL</a>,  under project <code>apache-beam-testing</code>, instance <code>beammetrics</code>. The database tables are automatically maintained by the import scripts.</p><h3 id="CommunityMetrics-MigratingJenkinsJobHistory">Migrating Jenkins Job History</h3><p>In some cases, it will be necessary to migrate historical data. For example, jobs can be renamed in Jenkins. Jenkins will correctly migrate history to refer to the new job name, but already imported job runs need to be migrated in the postgres database. Follow the steps below in order to migrate data:</p><ol><li><strong>Backup the database</strong>. Login to the <a class="external-link" href="https://console.cloud.google.com/sql/instances/beammetrics/backups?project=apache-beam-testing&amp;organizationId=433637338589" rel="nofollow">Database Backups page for beammetrics</a> and create a backup in case anything goes wrong.<br/><br/></li><li><strong>Connect to the database</strong>. From a console, login using gcloud command:<br/><code>gcloud beta sql connect beammetrics --database=beammetrics <span>--user=&lt;your_username&gt;<br/><br/></span></code></li><li><strong>Verify the data to migrate</strong>. Craft a SELECT query for the data you plan to update. For example:<br/><p><code>SELECT *</code><br/><code>FROM jenkins_builds jb</code><br/><code>WHERE jb.job_name = 'beam_PostCommit_Java_ValidatesRunner_Gearpump_Gradle' </code><br/><code>  AND NOT EXISTS (</code><br/><code>    SELECT * </code><br/><code>    FROM jenkins_builds </code><br/><code>    WHERE job_name = 'beam_PostCommit_Java_ValidatesRunner_Gearpump' <br/>      AND build_id=jb.build_id</code><br/><code>  );<br/><br/></code></p>Note that the import scripts will import recent history with the migrated job name from Jenkins; the <code>NOT EXISTS</code> clause above ensures that the duplicate history is not migrated from the previous name (it will be removed later). The <code>UPDATE</code> command will fail without this condition.<br/><br/></li><li><strong>Update the data</strong>. After validating the query targets the intended rows, modify it to update the necessary fields:<br/><br/><code>UPDATE jenkins_builds jb</code><br/><code>SET job_name = '<span>beam_PostCommit_Java_ValidatesRunner_Gearpump'<br/>WHERE &lt;query-from-above&gt;;<br/><br/></span></code></li><li><strong>Remove duplicate history</strong>. The import script will import recent history with the migrated job name from Jenkins. The final step is to remove the redundant history with the old job name:<br/><br/><code><span>DELETE jenkins_builds<br/>WHERE job_name = <span>'beam_PostCommit_Java_ValidatesRunner_Gearpump_Gradle'</span></span></code></li></ol><h2 id="CommunityMetrics-KubernetesCluster">Kubernetes Cluster</h2><p>A Kubernetes cluster hosts the data ingestion scripts and the Grafana frontend. Our cluster is deployed on <a class="external-link" href="https://cloud.google.com" rel="nofollow">Google Cloud Platform</a>, under project <code>apache-beam-testing</code>, cluster <code>metrics</code>, workload <code>beamgrafana</code>. The following sections cover instructions for deploying and updating the Kubernetes cluster. Only accounts with the <span style="color: rgb(32,33,36);"><code>container.deployments.update</code> and <code>container.deployments.create</code> permissions are able to do this. If you need to deploy or update the cluster, request that someone with the appropriate permissions follow these instructions.</span></p><h3 id="CommunityMetrics-FirstTimePrep">First Time Prep</h3><p>If you haven't worked on the <code>apache-beam-testing</code> GCP project before, there is some configuration work required first.</p><ul><li>Configure gcloud &amp; kubectl: <a class="external-link" href="https://cloud.google.com/kubernetes-engine/docs/quickstart" rel="nofollow">https://cloud.google.com/kubernetes-engine/docs/quickstart</a><ul><li>In particular, either set the default project and compute zone to match <code>apache-beam-testing</code> and the <code>metrics</code> cluster, or remember to use those as parameters in the steps below.</li></ul></li><li>Configure PosgreSQL <ul><li>Check on this link to configure connection from kubernetes to postgresql: <a class="external-link" href="https://cloud.google.com/sql/docs/postgres/connect-kubernetes-engine" rel="nofollow">https://cloud.google.com/sql/docs/postgres/connect-kubernetes-engine</a></li></ul></li></ul><h3 id="CommunityMetrics-DeploytheCluster">Deploy the Cluster</h3><p>Execute the following from the <code>.test-infra/metrics</code> directory of the Apache Beam repository:</p><ul><li>Add secrets for grafana: <code>kubectl create secret generic grafana-admin-pwd --from-literal=grafana_admin_password=&lt;pwd&gt;</code></li><li>Create persistent volume claims:</li></ul><pre>kubectl create -f beam-grafana-etcdata-persistentvolumeclaim.yaml
kubectl create -f beam-grafana-libdata-persistentvolumeclaim.yaml
kubectl create -f beam-grafana-logdata-persistentvolumeclaim.yaml</pre><ul><li>Build and publish sync containers ./build_and_publish_containers.sh</li><li>Create deployment <code>kubectl create -f beamgrafana-deploy.yaml</code></li></ul><h3 id="CommunityMetrics-UpdatetheCluster">Update the Cluster</h3><p><a class="external-link" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" rel="nofollow">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/</a></p><pre><span class="pl-c" style="color: rgb(106,115,125);"><span class="pl-c"><br/>## Update deployment from yaml file <br/>## Update yaml file and build containers<br/>./build_and_publish_containers.sh<br/>## Deploy new version<br/>kubectl replace -f beamgrafana-deploy.yaml<br/><br/>## Manual partial update<br/>#</span> Build and publish sync containers</span>
<span class="pl-c1" style="color: rgb(0,92,197);">cd</span> sync/jenkins
docker build -t gcr.io/<span class="pl-smi">${PROJECT_ID}</span>/beammetricssyncjenkins:v1 <span class="pl-c1" style="color: rgb(0,92,197);">.</span>
docker push -t gcr.io/<span class="pl-smi">${PROJECT_ID}</span>/beammetricssyncjenkins:v1

<span class="pl-c" style="color: rgb(106,115,125);"><span class="pl-c">#</span> If needed check current pod status</span>
kubectl get pods
kubectl describe pod <span class="pl-k" style="color: rgb(215,58,73);">&lt;</span>pod_id<span class="pl-k" style="color: rgb(215,58,73);">&gt;</span>

<span class="pl-c" style="color: rgb(106,115,125);"><span class="pl-c">#</span> Update container image via one of the following.</span>
<span class="pl-c" style="color: rgb(106,115,125);"><span class="pl-c">#</span># update image for container </span>
kubectl <span class="pl-c1" style="color: rgb(0,92,197);">set</span> image deployment/beamgrafana container=<span class="pl-k" style="color: rgb(215,58,73);">&lt;</span>new_image_name<span class="pl-k" style="color: rgb(215,58,73);">&gt;</span></pre><h2 id="CommunityMetrics-GrafanaUI">Grafana UI</h2><p>The Grafana dashboarding frontend is deployed as part of the Kubernetes cluster. The website is exposed at public IP <a class="external-link" href="http://metrics.beam.apache.org/" rel="nofollow">http://metrics.beam.apache.org/</a>.</p><p>When you deploy a new Grafana instance, there is some one-time setup:</p><ol><li>Log-in at <a class="external-link" href="http://localhost:3000/" rel="nofollow">http://localhost:3000</a> with username <code>admin</code> and the value specified for <code>GF_SECURITY_ADMIN_PASSWORD</code> in <a class="external-link" href="https://github.com/apache/beam/blob/master/.test-infra/metrics/docker-compose.yml" rel="nofollow"><code>docker-compose.yml</code></a>.</li><li>Add Postgres as a data source:<ol><li>Click the 'Add data source' button.</li><li>Fill out the following config:<ul><li><span>Name</span>: BeamPSQL</li><li><span>Type</span>: PostgreSQL</li><li><span>Host</span> beampostgresql:5432</li><li><span>Database</span>: beam_metrics</li><li><span>User</span>: admin</li><li><span>Password</span>: <code>POSTGRES_PASSWORD</code> in <a class="external-link" href="https://github.com/apache/beam/blob/master/.test-infra/metrics/docker-compose.yml" rel="nofollow"><code>docker-compose.yml</code></a>.</li><li><span>SSL Mode</span>: Disable</li></ul></li></ol></li><li>Change default organization name to &quot;Beam&quot; to let anonymous users browse dashboards without logging in. This must be done manually, since it's impossible to do it via configuration (see issue: <a class="external-link" href="https://github.com/grafana/grafana/issues/2908" rel="nofollow">https://github.com/grafana/grafana/issues/2908</a>).<ol><li>Log in as an administator</li><li>Go to 'Server Admin' / 'Orgs'</li><li>There should be one organization called 'Main Org.' Click the name and change it to &quot;Beam&quot;</li></ol></li><li>Change home dashboard. Just like in the previous step, this must be done manually, due to <a class="external-link" href="https://github.com/grafana/grafana/issues/10266" rel="nofollow">https://github.com/grafana/grafana/issues/10266</a>.<ol><li>Log in as an administrator</li><li>Click at top-left on &quot;Home&quot;. Find a dashboard called &quot;Home / Getting Started&quot; and mark it as favourite (give it a star)</li><li>Go to 'Configuration' / 'Preferences'</li><li>Choose &quot;Home / Getting Started&quot; from a drop-down list next to the 'Home Dashboard' label</li></ol></li></ol><p><br/></p><p>To configure the InfluxDB Data Source:</p><ol><li>Log-in at <a class="external-link" href="http://localhost:3000," rel="nofollow">http://localhost:3000</a> as specified above.</li><li>Add InfluxDB as a data source:<ol><li>Click the 'Add data source' button</li><li>Fill out the following config:<ul><li>Name: BeamInfluxDB</li><li>URL: <a class="external-link" href="http://localhost:8086" rel="nofollow">http://localhost:8086</a></li><li>Access: Browser</li><li>Database: beam_test_metrics</li></ul></li></ol></li></ol><h3 id="CommunityMetrics-UpdatingDashboards">Updating Dashboards</h3><p>The Grafana dashboards are exported as JSON files in the codebase. Dashboards can be easily exported from the UI.</p><ol><li>Run local version of grafana using docker-compose. Refer to <a class="external-link" href="https://github.com/apache/beam/blob/master/.test-infra/metrics/README.md" rel="nofollow">README.md</a> for more information.</li><li>Once dashboards are manually updated via UI, re-export every modified or new dashboard to JSON file:<br/><ol><li>Click at top-right on &quot;Share dashboard&quot; button. <br/><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image confluence-thumbnail" draggable="false" height="101" src="/confluence/download/thumbnails/95652995/share.png?version=1&amp;modificationDate=1591193558000&amp;api=v2" data-image-src="/confluence/download/attachments/95652995/share.png?version=1&amp;modificationDate=1591193558000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="157453494" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="share.png" data-base-url="https://cwiki.apache.org/confluence" data-linked-resource-content-type="image/png" data-linked-resource-container-id="95652995" data-linked-resource-container-version="20" alt=""></span></li><li>A modal dialog will appear. Go to &quot;Export&quot; tab and click &quot;Save to file&quot; button.<br/><span class="confluence-embedded-file-wrapper confluence-embedded-manual-size"><img class="confluence-embedded-image" draggable="false" height="244" src="/confluence/download/attachments/95652995/share2.png?version=1&amp;modificationDate=1591193639000&amp;api=v2" data-image-src="/confluence/download/attachments/95652995/share2.png?version=1&amp;modificationDate=1591193639000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="157453495" data-linked-resource-version="1" data-linked-resource-type="attachment" data-linked-resource-default-alias="share2.png" data-base-url="https://cwiki.apache.org/confluence" data-linked-resource-content-type="image/png" data-linked-resource-container-id="95652995" data-linked-resource-container-version="20" alt=""></span></li></ol></li><li>Save/update file in <span class="js-path-segment" style="color: rgb(88,96,105);"><a class="external-link" href="https://github.com/apache/beam/tree/master/.test-infra" rel="nofollow" style="text-decoration: none;"><span>.test-infra</span></a></span><span class="separator" style="color: rgb(88,96,105);">/</span><span class="js-path-segment" style="color: rgb(88,96,105);"><a class="external-link" href="https://github.com/apache/beam/tree/master/.test-infra/metrics" rel="nofollow" style="text-decoration: none;"><span>metrics</span></a></span><span class="separator" style="color: rgb(88,96,105);">/</span><span class="js-path-segment" style="color: rgb(88,96,105);"><a class="external-link" href="https://github.com/apache/beam/tree/master/.test-infra/metrics/grafana" rel="nofollow" style="text-decoration: none;"><span>grafana</span></a></span><span class="separator" style="color: rgb(88,96,105);">/</span><strong class="final-path">dashboards</strong>.</li><li>Create a Pull Request. New dashboards will be automatically deployed to Grafana after merge.</li></ol><h1 id="CommunityMetrics-Appendix">Appendix</h1><h3 id="CommunityMetrics-UsefulKubernetescommandsandhints">Useful Kubernetes commands and hints</h3><pre><span class="pl-c" style="color: rgb(106,115,125);"><span class="pl-c">#</span> Get pods</span>
kubectl get pods

<span class="pl-c" style="color: rgb(106,115,125);"><span class="pl-c">#</span> Get detailed status</span>
kubectl describe pod <span class="pl-k" style="color: rgb(215,58,73);">&lt;</span>pod_name<span class="pl-k" style="color: rgb(215,58,73);">&gt;</span>

<span class="pl-c" style="color: rgb(106,115,125);"><span class="pl-c">#</span> Get logs</span>
kubectl log <span class="pl-k" style="color: rgb(215,58,73);">&lt;</span>PodName<span class="pl-k" style="color: rgb(215,58,73);">&gt;</span> <span class="pl-k" style="color: rgb(215,58,73);">&lt;</span>ContainerName<span class="pl-k" style="color: rgb(215,58,73);">&gt;</span>

<span class="pl-c" style="color: rgb(106,115,125);"><span class="pl-c">#</span> Set kubectl logging level: -v [1..10]</span>
https://github.com/kubernetes/kubernetes/issues/35054</pre><p><br/></p><pre># Update kubernetes secret</pre><pre><code>kubectl create secret generic production-tls --from-file=./tls.key --from-file=./tls.crt --dry-run -o yaml | kubectl apply -f -</code></pre><h3 id="CommunityMetrics-Usefuldockercommandsandhints">Useful docker commands and hints</h3><ul><li>Connect from one container to another<ul><li><code>curl &lt;containername&gt;:&lt;port&gt;</code></li></ul></li><li>Remove all containers/images/volumes</li></ul><h3 id="CommunityMetrics-sudodockerrm$(sudodockerps-a-q)sudodockerrmi$(sudodockerimages-q)sudodockervolumepruneEnablingthelegendondashboards">sudo docker rm <span class="pl-s" style="color: rgb(3,47,98);"><span class="pl-pds">$(</span>sudo docker ps -a -q<span class="pl-pds">)</span></span> sudo docker rmi <span class="pl-s" style="color: rgb(3,47,98);"><span class="pl-pds">$(</span>sudo docker images -q<span class="pl-pds">)</span></span> sudo docker volume prune<br/><br/>Enabling the legend on dashboards</h3><p><span class="tL8wMe EMoHub">If you have a graph that doesn't have the legend, you can enable it by clicking on Graph name → More → ToggleLegend.  </span></p><p><code><br/></code></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p><p><br/></p>