<h2 id="DependencyUpgrades-Howtoperformadependencyupgrade?">How to perform a dependency upgrade?</h2><p>To perform a dependency upgrade we want to ensure that the PR is not introducing any new <a class="external-link" href="https://jlbp.dev/glossary" rel="nofollow">linkage errors</a>. We do this by combining successful Jenkins test runs with analysis performed using a linkage checker. This allows us to gain confidence that we are minimizing the number of linkage issues that will arise for users. To perform a dependency upgrade:</p><ol><li><a href="#DependencyUpgrades-HowtofindallGradlesubprojectsthatareimpactedbythedependencychange">Find all Gradle subprojects that are impacted by the dependency change</a>.</li><li>For each Gradle subproject:<ol><li>Perform the <code>before</code> and <code>after</code> <a href="#DependencyUpgrades-Linkagecheckeranalysis">linkage checker analysis</a>.</li><li>Provide the results as part of your PR.</li></ol></li><li>For each Gradle subproject:<ol><li>Find and run <a href="/confluence/display/BEAM/Dependency+Upgrades">relevant Jenkins test suites</a>.</li></ol></li></ol><h3 id="DependencyUpgrades-HowtofindallGradlesubprojectsthatareimpactedbythedependencychange">How to find all Gradle subprojects that are impacted by the dependency change</h3><ol><li><p class="auto-cursor-target">Execute the command below will print out a dependency report in a text file for each project:</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Default" data-theme="Default">./gradlew dependencyReport</pre>
</div></div></li><li><p class="auto-cursor-target"><span style="letter-spacing: 0.0px;">Grep for a specific maven artifact identifier such as guava in all the dependency reports with:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Default" data-theme="Default">grep -l &quot;guava&quot; `find ./ -name dependencies.txt`</pre>
</div></div></li></ol><p><br/></p><h3 id="DependencyUpgrades-Linkagecheckeranalysis">Linkage checker analysis</h3><div class="confluence-information-macro confluence-information-macro-note conf-macro output-block" data-hasbody="true" data-macro-name="note"><span class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon"> </span><div class="confluence-information-macro-body"><p>This step relies on modifying your local maven repository, typically found in <code>~/.m2/</code>.</p></div></div><p><br/></p><ol><li><p class="auto-cursor-target">Use the shell script to do this on your behalf (note that it will run the manual command below on your current workspace and also on HEAD):</p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Default" data-theme="Default">/bin/bash sdks/java/build-tools/beam-linkage-check.sh origin/master &lt;your branch name&gt; &quot;artifactId1,artifactId2,...&quot;</pre>
</div></div><div class="confluence-information-macro confluence-information-macro-information conf-macro output-block" data-hasbody="true" data-macro-name="info"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"> </span><div class="confluence-information-macro-body"><p>If you omit the artifactIds, it uses <code>beam-sdks-java-core beam-sdks-java-io-google-cloud-platform beam-runners-google-cloud-dataflow-java beam-sdks-java-io-hadoop-format</code>; these artifacts often suffer dependency conflicts.</p></div></div></li><li><p class="auto-cursor-target"><span style="letter-spacing: 0.0px;">Copy and paste the output to the PR. If it is large, you may want to use a GitHub gist. For example PRs (</span><a class="external-link" href="https://github.com/apache/beam/pull/10508" rel="nofollow" style="letter-spacing: 0.0px;">1</a><span style="letter-spacing: 0.0px;">, </span><a class="external-link" href="https://github.com/apache/beam/pull/11095" rel="nofollow" style="letter-spacing: 0.0px;">2</a><span style="letter-spacing: 0.0px;">, </span><a class="external-link" href="https://github.com/apache/beam/pull/11042" rel="nofollow" style="letter-spacing: 0.0px;">3</a><span style="letter-spacing: 0.0px;">, </span><a class="external-link" href="https://github.com/apache/beam/pull/10674" rel="nofollow" style="letter-spacing: 0.0px;">4</a><span style="letter-spacing: 0.0px;">, and </span><a class="external-link" href="https://github.com/apache/beam/pull/10714" rel="nofollow" style="letter-spacing: 0.0px;">5</a><span style="letter-spacing: 0.0px;">).</span></p></li><li><p class="auto-cursor-target"><span style="letter-spacing: 0.0px;">Note that you can manually run the linkage checker on your current workspace by invoking:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Default" data-theme="Default">./gradlew -Ppublishing -PjavaLinkageArtifactIds=artifactId1,artifactId2,... :checkJavaLinkage</pre>
</div></div></li><li><p class="auto-cursor-target"><span style="letter-spacing: 0.0px;">Check the example output is:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Default" data-theme="Default">Class org.brotli.dec.BrotliInputStream is not found;
  referenced by 1 class file
    org.apache.beam.repackaged.core.org.apache.commons.compress.compressors.brotli.BrotliCompressorInputStream (beam-sdks-java-core-2.20.0-SNAPSHOT.jar)
Class com.github.luben.zstd.ZstdInputStream is not found;
  referenced by 1 class file
    org.apache.beam.repackaged.core.org.apache.commons.compress.compressors.zstandard.ZstdCompressorInputStream (beam-sdks-java-core-2.20.0-SNAPSHOT.jar)
Class com.github.luben.zstd.ZstdOutputStream is not found;
  referenced by 1 class file
    org.apache.beam.repackaged.core.org.apache.commons.compress.compressors.zstandard.ZstdCompressorOutputStream (beam-sdks-java-core-2.20.0-SNAPSHOT.jar)
Class org.apache.beam.vendor.bytebuddy.v1_9_3.net.bytebuddy.jar.asm.commons.ModuleHashesAttribute is not found;
  referenced by 1 class file
    org.apache.beam.vendor.bytebuddy.v1_9_3.net.bytebuddy.jar.asm.commons.ClassRemapper (beam-vendor-bytebuddy-1_9_3-0.1.jar)</pre>
</div></div></li><li><p class="auto-cursor-target"><span style="letter-spacing: 0.0px;">Delete any installed Apache Beam SNAPSHOT artifacts:</span></p><div class="code panel pdl conf-macro output-block" data-hasbody="true" data-macro-name="code" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Default" data-theme="Default">rm -rf ~/.m2/repository/org/apache/beam</pre>
</div></div></li></ol><h3 id="DependencyUpgrades-RunrelevantJenkinstestsuites">Run relevant Jenkins test suites</h3><p>You can find all Jenkins job configurations within <a class="external-link" href="https://github.com/apache/beam/tree/master/.test-infra/jenkins" rel="nofollow">https://github.com/apache/beam/tree/master/.test-infra/jenkins</a> and request that the reviewer run the relevant test suites by providing them with a list of all the relevant trigger phrases. You can perform this request directly on your PR or on the dev mailing list, for <a class="external-link" href="https://lists.apache.org/thread.html/re94aaf22ecac5d069571c3dc6b2c02b9ff8230bf8277b6216b579dbd%40%3Cdev.beam.apache.org%3E" rel="nofollow">example</a>.</p><p><br/></p><h2 id="DependencyUpgrades-GoogleCloud-relateddependencyupgrades">Google Cloud-related dependency upgrades</h2><p>To provide the consistent dependencies to Beam users, follow the following steps when upgrading Google Cloud-related dependencies:</p><ol style=""><li>Set the Libraries BOM version.<ol style=""><li>Find the latest release in<span> </span><a class="external-link" href="https://github.com/googleapis/java-cloud-bom/releases" rel="nofollow">https://github.com/googleapis/java-cloud-bom/releases</a><span> </span>and set libraries-bom value in <a class="external-link" href="https://github.com/apache/beam/blob/master/buildSrc/src/main/groovy/org/apache/beam/gradle/BeamModulePlugin.groovy" rel="nofollow">BeamModulePlugin.groovy</a></li></ol></li><li>Find core Google Java library versions.<ol style=""><li>Such as gRPC, Protobuf, Guava, Google Auth Library in the release note of the Libraries BOM and set them in BeamModulePlugin.groovy</li></ol></li><li>Find appropriate Netty version by checking<span> </span><code>io.grpc:grpc-netty</code>'s dependency declaration. For example, you can tell gRPC version 1.49.0 was built with Netty &quot;4.1.77.Final&quot; by reading<span> </span><a class="external-link" href="https://search.maven.org/artifact/io.grpc/grpc-netty/1.49.0/jar" rel="nofollow">https://search.maven.org/artifact/io.grpc/grpc-netty/1.49.0/jar</a>:<pre><code>   &lt;artifactId&gt;netty-codec-http2&lt;/artifactId&gt;
   &lt;version&gt;4.1.77.Final&lt;/version&gt;
</code></pre>Update netty_version in BeamModulePlugin.groovy</li><li>Find netty-tcnative version via<span> </span><code>netty-parent</code><span> </span>artifact. For example, you can tell Netty 4.1.77.Final was built with netty-tcnative &quot;2.0.52.Final&quot;.<span> </span><a class="external-link" href="https://search.maven.org/artifact/io.netty/netty-parent/4.1.77.Final/jar" rel="nofollow">https://search.maven.org/artifact/io.netty/netty-parent/4.1.77.Final/jar</a>:<pre><code>    &lt;tcnative.version&gt;2.0.52.Final&lt;/tcnative.version&gt;
</code></pre>Update netty_tcnative_boringssl_static version in BeamModulePlugin.groovy</li></ol><p><br/></p><p><br/></p><p><br/></p>